var delay=(function(){var a=0;return function(c,b){clearTimeout(a);a=setTimeout(c,b)}})();var dictionary=function(){this.keys=new Array();this.data=new Array();this.put=function(a,b){if(this.data[a]==null){this.keys.push(b)}this.data[a]=b};this.get=function(a){return this.data[a]};this.remove=function(a){this.keys.remove(a);this.data[a]=null};this.isEmpty=function(){return this.keys.length==0};this.size=function(){return this.keys.length}};var ellipsis=function(e,a){if(e.length*2<a){return e}var f=e.replace(/[^\x00-\xff]/g,"^^");var d=f.substring(0,a);var b=(d.split("^").length-1)/2;a=a-b;var c=e.substring(0,a);if(a<e.length){return c+"..."}else{return c}};var mapContainer,detailWindow;$(document).ready(function(){if(typeof(BMap)==="undefined"){$("body").css({height:"auto"});$("#container").hide();$("#search-panel").hide();$("#unconnected-panel").show();return false}var j=new BMap.Icon("/Content/themes/images/map/location0.png",new BMap.Size(32,32));var i=new BMap.Icon("/Content/themes/images/map/location1.png",new BMap.Size(32,32));var h=new BMap.Icon("/Content/themes/images/map/location2.png",new BMap.Size(32,32));var e=new BMap.Icon("/Content/themes/images/map/location3.png",new BMap.Size(32,32));var d=new BMap.Icon("/Content/themes/images/map/location4.png",new BMap.Size(32,32));var f=new BMap.Icon("/Content/themes/images/map/shadow.png",new BMap.Size(32,32));mapContainer=new BMap.Map("container");mapContainer.centerAndZoom("\u4e0a\u6d77\u5e02",11);mapContainer.addControl(new BMap.ScaleControl());mapContainer.addControl(new BMap.MapTypeControl());mapContainer.addControl(new BMap.NavigationControl({type:BMAP_NAVIGATION_CONTROL_ZOOM,anchor:BMAP_ANCHOR_BOTTOM_RIGHT}));var s=new BMap.ContextMenu();s.addItem(new BMap.MenuItem("\u5f53\u524d\u5750\u6807",function(t){prompt("\u7ecf\u5ea6,\u7eac\u5ea6\uff1a",t.lng+","+t.lat)},{iconUrl:"/Content/themes/images/map/point.png"}));mapContainer.addContextMenu(s);var k=new BMap.PanoramaControl();k.setOffset(new BMap.Size(10,60));mapContainer.addControl(k);mapContainer.enableScrollWheelZoom(true);var p,o=new BMap.Autocomplete({input:"searchbox-input",location:"\u4e0a\u6d77\u5e02"});o.addEventListener("onhighlight",function(v){var w="",u="";var t=v.fromitem.value;if(v.fromitem.index>-1){u=t.province+t.city+t.district+t.street+t.business}w="FromItem<br />index = "+v.fromitem.index+"<br />value = "+u;u="";if(v.toitem.index>-1){t=v.toitem.value;u=t.province+t.city+t.district+t.street+t.business}w+="<br />ToItem<br />index = "+v.toitem.index+"<br />value = "+u;$("#search-results").html(w)});o.addEventListener("onconfirm",function(u){var t=u.item.value;p=t.province+t.city+t.district+t.street+t.business;$("#search-results").html("onconfirm<br />index = "+u.item.index+"<br />value = "+p);l()});$("#search-button").on("click",function(){p=$("#searchbox-input").val();if(p.length===0){return}l()});var l=function(){var t=new BMap.LocalSearch(mapContainer,{renderOptions:{map:mapContainer}});mapContainer.clearOverlays();t.search(p)};(new BMap.LocalCity()).get(function(t){var u=t.name;mapContainer.centerAndZoom(u,11);o.setLocation(u)});mapContainer.addEventListener("zoomend",function(){delay(c,1000)});mapContainer.addEventListener("dragend",function(){delay(c,1000)});var m;var c=function(){var u=mapContainer.getBounds();var v=u.getSouthWest();var t=u.getNorthEast();var w=function(A){if(A.status===0){if(!(m&&m.length>0)){return}var B=[],y=A.points;for(var x=0;x<y.length;x++){B.push(a(m[x],y[x]))}var z=mapContainer.getZoom();g(z,B);for(var x=0;x<B.length;x++){mapContainer.addOverlay(B[x])}}};$.ajax({url:"/Configuration/GetMarkers",data:{minlng:(v.lng-0.02).toFixed(6),minlat:(v.lat-0.01).toFixed(6),maxlng:t.lng,maxlat:t.lat},dataType:"json",beforeSend:function(){n()},error:function(x,z,y){alert("ajax\u8bf7\u6c42\u65f6\u53d1\u751f\u9519\u8bef")},success:function(C,D,B){if(C.success===true){m=C.data;var A=[];for(var z=0;z<m.length;z++){var x=new BMap.Point(m[z].lng,m[z].lat);A.push(x)}var y=new BMap.Convertor();y.translate(A,1,5,w)}}})};var q=new BMap.Geocoder();var a=function(v,t){var u=new BMap.Marker(t||new BMap.Point(v.lng,v.lat),{title:v.name,enableMassClear:false});var w=new BMap.Label(v.name,{offset:new BMap.Size(30,3)});u._cfg=v;if(v.level===0){w.setStyle({background:"#48ac2e",border:"#48ac2e","border-radius":"3px",padding:"3px 5px",color:"#fff"});u.setIcon(j);u.setShadow(f);u.setLabel(w)}else{if(v.level===1){w.setStyle({background:"#f04b51",border:"#f04b51","border-radius":"3px",padding:"3px 5px",color:"#fff"});u.setIcon(i);u.setShadow(f);u.setLabel(w)}else{if(v.level===2){w.setStyle({background:"#efa91f",border:"#efa91f","border-radius":"3px",padding:"3px 5px",color:"#fff"});u.setIcon(h);u.setShadow(f);u.setLabel(w)}else{if(v.level===3){w.setStyle({background:"#f5d313",border:"#f5d313","border-radius":"3px",padding:"3px 5px",color:"#fff"});u.setIcon(e);u.setShadow(f);u.setLabel(w)}else{if(v.level===4){w.setStyle({background:"#0892cd",border:"#0892cd","border-radius":"3px",padding:"3px 5px",color:"#fff"});u.setIcon(d);u.setShadow(f);u.setLabel(w)}}}}}u.addEventListener("click",function(y){var x=y.target._cfg;b();detailWindow.open(y.target);detailWindow.setTitle(x.name);detailWindow.setContent(r(x));q.getLocation(y.target.getPosition(),function(A){var z=A.addressComponents;var B=z.province+z.city+z.district+z.street+z.streetNumber;$("table.content tr:last td:last").html(B).attr({title:B})})});return u};var n=function(){var v=mapContainer.getOverlays();for(var u=0;u<v.length;u++){var t=v[u];if(!t._cfg){continue}mapContainer.removeOverlay(t)}};var g=function(v,w){for(var u=0;u<w.length;u++){var t=w[u];if(!t._cfg){continue}if(v<11){t.getLabel().hide()}else{t.getLabel().show()}}};var b=function(){if(!detailWindow){detailWindow=new BMapLib.SearchInfoWindow(mapContainer,"",{title:"",width:290,height:135,panel:"panel",enableAutoPan:true,searchTypes:[BMAPLIB_TAB_SEARCH,BMAPLIB_TAB_TO_HERE,BMAPLIB_TAB_FROM_HERE]})}if(detailWindow._isOpen){detailWindow.close()}};var r=function(t){var u=['<div class="contentWndBox">','<table border="0" cellpadding="0" cellspacing="0" class="content">',"<tr>",'<td valign="top" class="title">\u7c7b\u578b\uff1a</td>','<td valign="top" title="'+t.type+'">'+t.type+"</td>","</tr>","<tr>",'<td valign="top" class="title">\u7ecf\u5ea6\uff1a</td>','<td valign="top" title="'+t.lng+'">'+t.lng+"</td>","</tr>","<tr>",'<td valign="top" class="title">\u7eac\u5ea6\uff1a</td>','<td valign="top" title="'+t.lat+'">'+t.lat+"</td>","</tr>","<tr>",'<td valign="top" class="title">\u5730\u5740\uff1a</td>','<td valign="top" title=""></td>',"</tr>","</table>",'<table border="0" cellpadding="0" cellspacing="0" class="alarm">',"<tr>",'<td class="title">\u4e00\u7ea7\u544a\u8b66\uff1a</td>','<td><a href="/Home/ActiveAlarm" target="_blank">'+t.alm1+"&nbsp;\u6761\u00bb</a></td>",'<td class="title">\u4e8c\u7ea7\u544a\u8b66\uff1a</td>','<td><a href="/Home/ActiveAlarm" target="_blank">'+t.alm2+"&nbsp;\u6761\u00bb</a></td>","</tr>","<tr>",'<td class="title">\u4e09\u7ea7\u544a\u8b66\uff1a</td>','<td><a href="/Home/ActiveAlarm" target="_blank">'+t.alm3+"&nbsp;\u6761\u00bb</a></td>",'<td class="title">\u56db\u7ea7\u544a\u8b66\uff1a</td>','<td><a href="/Home/ActiveAlarm" target="_blank">'+t.alm4+"&nbsp;\u6761\u00bb</a></td>","</tr>","</table>","</div>"];return u.join("")}});
