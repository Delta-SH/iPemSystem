Ext.apply(Ext.form.VTypes,{password:function(c,b){if(b.confirmTo){var a=Ext.getCmp(b.confirmTo);return(c==a.getValue())}return true}});Ext.define("UserModel",{extend:"Ext.data.Model",fields:[{name:"index",type:"int"},{name:"id",type:"string"},{name:"uid",type:"string"},{name:"roleId",type:"string"},{name:"roleName",type:"string"},{name:"empId",type:"string"},{name:"empName",type:"string"},{name:"empNo",type:"string"},{name:"sex",type:"int"},{name:"sexName",type:"string"},{name:"mobile",type:"string"},{name:"email",type:"string"},{name:"password",type:"string"},{name:"created",type:"string"},{name:"limited",type:"string"},{name:"lastLogined",type:"string"},{name:"lastPasswordChanged",type:"string"},{name:"isLockedOut",type:"boolean"},{name:"lastLockedout",type:"string"},{name:"comment",type:"string"},{name:"enabled",type:"boolean"}],idProperty:"id"});var currentStore=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:20,model:"UserModel",proxy:{type:"ajax",url:"/Account/GetUsers",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},extraParams:{roles:[],names:[]},listeners:{exception:function(c,b,a){Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:a.getError(),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}},simpleSortMode:true}});var comboRoleStore=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:1024,fields:[{name:"id",type:"string"},{name:"text",type:"string"},{name:"comment",type:"string"}],proxy:{type:"ajax",url:"/Account/GetComboRoles",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"}},listeners:{load:function(b,a,c){if(c&&!Ext.isEmpty(a)&&a.length>0){Ext.getCmp("roleId").select(a[0])}}}});var multiComboRoleStore=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:1024,fields:[{name:"id",type:"string"},{name:"text",type:"string"},{name:"comment",type:"string"}],proxy:{type:"ajax",url:"/Account/GetComboRoles",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"}}});var currentPagingToolbar=$$iPems.clonePagingToolbar(currentStore);var saveWnd=Ext.create("Ext.window.Window",{title:"User",height:400,width:600,modal:true,border:false,hidden:true,closeAction:"hide",opaction:$$iPems.Action.Add,items:[{xtype:"form",id:"saveForm",border:false,defaultType:"textfield",fieldDefaults:{labelWidth:60,labelAlign:"left",margin:"15 15 15 15",anchor:"100%"},items:[{xtype:"container",layout:"hbox",items:[{xtype:"container",flex:1,layout:"anchor",items:[{id:"id",name:"id",xtype:"textfield",fieldLabel:"\u7528\u6237\u6807\u8bc6",allowBlank:false,readOnly:true},{id:"roleId",name:"roleId",xtype:"combobox",fieldLabel:"\u96b6\u5c5e\u89d2\u8272",displayField:"text",valueField:"id",typeAhead:true,queryMode:"local",triggerAction:"all",emptyText:"\u8bf7\u9009\u62e9\u96b6\u5c5e\u89d2\u8272...",selectOnFocus:true,forceSelection:true,allowBlank:false,store:comboRoleStore},{id:"password",name:"password",xtype:"textfield",inputType:"password",fieldLabel:"\u767b\u5f55\u5bc6\u7801",allowBlank:false,hidden:false},{id:"limited",name:"limited",xtype:"datefield",fieldLabel:"\u6709\u6548\u65e5\u671f",value:new Date(),editable:false,allowBlank:false},{id:"comment",name:"comment",xtype:"textareafield",fieldLabel:"\u7528\u6237\u5907\u6ce8",height:100,maxLength:500}]},{xtype:"container",flex:1,layout:"anchor",items:[{id:"uid",name:"uid",xtype:"textfield",fieldLabel:"\u7528\u6237\u540d\u79f0",allowBlank:false,readOnly:false},{id:"empId",name:"empId",xtype:"EmployeePicker",fieldLabel:"\u96b6\u5c5e\u5458\u5de5",allowBlank:false},{id:"confirmPassword",name:"confirmPassword",xtype:"textfield",inputType:"password",fieldLabel:"\u786e\u8ba4\u5bc6\u7801",allowBlank:false,hidden:false,vtype:"password",vtypeText:"\u5bc6\u7801\u4e0d\u4e00\u81f4",confirmTo:"password"},{id:"isLockedOut",name:"isLockedOut",xtype:"checkboxfield",fieldLabel:"\u9501\u5b9a\u72b6\u6001",boxLabel:"(\u52fe\u9009\u9501\u5b9a\u7528\u6237)",inputValue:true,checked:false},{id:"enabled",name:"enabled",xtype:"checkboxfield",fieldLabel:"\u7528\u6237\u72b6\u6001",boxLabel:"(\u52fe\u9009\u8868\u793a\u542f\u7528)",inputValue:true,checked:false}]}]}]}],buttons:[{id:"saveResult",xtype:"iconlabel",text:""},{xtype:"tbfill"},{xtype:"button",text:"\u4fdd\u5b58",handler:function(b,f){var c=Ext.getCmp("saveForm"),d=c.getForm(),a=Ext.getCmp("saveResult");a.setTextWithIcon("","");if(d.isValid()){a.setTextWithIcon("\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...","x-icon-loading");d.submit({submitEmptyText:false,clientValidation:true,preventWindow:true,url:"/Account/SaveUser",params:{action:saveWnd.opaction},success:function(e,g){a.setTextWithIcon(g.result.message,"x-icon-accept");if(saveWnd.opaction==$$iPems.Action.Add){currentStore.loadPage(1)}else{currentPagingToolbar.doRefresh()}},failure:function(g,h){var e="undefined error.";if(!Ext.isEmpty(h.result)&&!Ext.isEmpty(h.result.message)){e=h.result.message}a.setTextWithIcon(e,"x-icon-error")}})}else{a.setTextWithIcon("\u8868\u5355\u586b\u5199\u9519\u8bef","x-icon-error")}}},{xtype:"button",text:"\u5173\u95ed",handler:function(a,b){saveWnd.close()}}]});var resetWnd=Ext.create("Ext.window.Window",{title:"\u91cd\u7f6e\u5bc6\u7801",glyph:61474,height:220,width:400,modal:true,border:false,hidden:true,closeAction:"hide",items:[{xtype:"form",id:"resetForm",border:false,defaultType:"textfield",fieldDefaults:{labelWidth:60,labelAlign:"left",margin:"15 15 15 15",anchor:"100%"},items:[{itemId:"id",xtype:"hiddenfield",value:""},{itemId:"uid",xtype:"textfield",fieldLabel:"\u7528\u6237\u540d\u79f0",allowBlank:false,readOnly:true},{id:"reset-password",itemId:"password",xtype:"textfield",inputType:"password",fieldLabel:"\u65b0\u7684\u5bc6\u7801",allowBlank:false,hidden:false},{id:"reset-confirmPassword",itemId:"confirmPassword",xtype:"textfield",inputType:"password",fieldLabel:"\u786e\u8ba4\u5bc6\u7801",allowBlank:false,hidden:false,vtype:"password",vtypeText:"\u5bc6\u7801\u4e0d\u4e00\u81f4",confirmTo:"reset-password"}]}],buttons:[{id:"resetResult",xtype:"iconlabel",text:""},{xtype:"tbfill"},{xtype:"button",text:"\u91cd\u7f6e",handler:function(b,f){var c=Ext.getCmp("resetForm"),d=c.getForm(),g=c.getComponent("id").getValue(),a=Ext.getCmp("resetResult");a.setTextWithIcon("","");if(d.isValid()&&!Ext.isEmpty(g)){Ext.Msg.confirm("\u786e\u8ba4\u5bf9\u8bdd\u6846","\u60a8\u786e\u8ba4\u8981\u91cd\u7f6e\u5bc6\u7801\u5417\uff1f",function(h,i){if(h==="yes"){a.setTextWithIcon("\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...","x-icon-loading");var e=c.getComponent("password").getValue();d.submit({submitEmptyText:false,clientValidation:true,preventWindow:true,url:"/Account/ResetPassword",params:{id:g,password:e},success:function(j,k){a.setTextWithIcon(k.result.message,"x-icon-accept")},failure:function(k,l){var j="undefined error.";if(!Ext.isEmpty(l.result)&&!Ext.isEmpty(l.result.message)){j=l.result.message}a.setTextWithIcon(j,"x-icon-error")}})}})}else{a.setTextWithIcon("\u8868\u5355\u586b\u5199\u9519\u8bef","x-icon-error")}}},{xtype:"button",text:"\u5173\u95ed",handler:function(a,b){resetWnd.close()}}]});var editCellClick=function(d,e,c){var a=d.getStore().getAt(e);if(Ext.isEmpty(a)){return false}var b=Ext.getCmp("saveForm").getForm();b.load({url:"/Account/GetUser",params:{id:a.raw.id,action:$$iPems.Action.Edit},waitMsg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...",waitTitle:"\u7cfb\u7edf\u63d0\u793a",success:function(i,j){i.clearInvalid();Ext.getCmp("saveResult").setTextWithIcon("","");var h=Ext.getCmp("uid"),g=Ext.getCmp("password"),f=Ext.getCmp("confirmPassword");h.setReadOnly(true);g.disable();g.hide();f.disable();f.hide();saveWnd.setGlyph(61442);saveWnd.setTitle("\u7f16\u8f91\u7528\u6237");saveWnd.opaction=$$iPems.Action.Edit;saveWnd.show()}})};var resetCellClick=function(c,e,b){var a=c.getStore().getAt(e);if(Ext.isEmpty(a)){return false}var d=Ext.getCmp("resetForm");d.getForm().reset();d.getComponent("id").setValue(a.raw.id);d.getComponent("uid").setValue(a.raw.uid);Ext.getCmp("resetResult").setTextWithIcon("","");resetWnd.show()};var deleteCellClick=function(c,d,b){var a=c.getStore().getAt(d);if(Ext.isEmpty(a)){return false}Ext.Msg.confirm("\u786e\u8ba4\u5bf9\u8bdd\u6846","\u60a8\u786e\u8ba4\u8981\u5220\u9664\u5417\uff1f",function(e,f){if(e==="yes"){Ext.Ajax.request({url:"/Account/DeleteUser",params:{id:a.raw.id},mask:new Ext.LoadMask(c,{msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(g,h){var i=Ext.decode(g.responseText,true);if(i.success){currentPagingToolbar.doRefresh()}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:i.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}})};var currentGridPanel=Ext.create("Ext.grid.Panel",{glyph:61458,title:"\u7cfb\u7edf\u7528\u6237\u4fe1\u606f",region:"center",store:currentStore,columnLines:true,disableSelection:false,loadMask:true,forceFit:false,listeners:{},viewConfig:{forceFit:true,trackOver:true,stripeRows:true,emptyText:'<h1 style="margin:20px">\u6ca1\u6709\u6570\u636e\u8bb0\u5f55</h1>',preserveScrollOnRefresh:true},columns:[{text:"\u5e8f\u53f7",dataIndex:"index",width:60,align:"left",sortable:true},{text:"\u7528\u6237\u540d\u79f0",dataIndex:"uid",width:100,align:"left",sortable:true},{text:"\u96b6\u5c5e\u89d2\u8272",dataIndex:"roleName",width:100,align:"left",sortable:true},{text:"\u96b6\u5c5e\u5458\u5de5",dataIndex:"empName",width:100,align:"left",sortable:true},{text:"\u5458\u5de5\u5de5\u53f7",dataIndex:"empNo",width:100,align:"left",sortable:true},{text:"\u6027\u522b",dataIndex:"sexName",width:100,align:"left",sortable:true},{text:"\u8054\u7cfb\u7535\u8bdd",dataIndex:"mobile",width:100,align:"left",sortable:true},{text:"Email",dataIndex:"email",width:100,align:"left",sortable:true},{text:"\u521b\u5efa\u65e5\u671f",dataIndex:"created",align:"left",width:100,sortable:true},{text:"\u6709\u6548\u65e5\u671f",dataIndex:"limited",align:"left",width:100,sortable:true},{text:"\u6700\u540e\u767b\u5f55\u65e5\u671f",dataIndex:"lastLogined",align:"left",width:100,sortable:true},{text:"\u5bc6\u7801\u66f4\u6539\u65e5\u671f",dataIndex:"lastPasswordChanged",align:"left",width:100,sortable:true},{text:"\u9501\u5b9a\u72b6\u6001",dataIndex:"isLockedOut",align:"left",width:100,sortable:true,renderer:function(a){return a?"\u9501\u5b9a":"\u6b63\u5e38"}},{text:"\u6700\u540e\u9501\u5b9a\u65e5\u671f",dataIndex:"lastLockedout",align:"left",width:100,sortable:true},{text:"\u7528\u6237\u5907\u6ce8",dataIndex:"comment",align:"left",width:100,sortable:true},{text:"\u7528\u6237\u72b6\u6001",dataIndex:"enabled",width:100,align:"left",sortable:true,renderer:function(a){return a?"\u6709\u6548":"\u7981\u7528"}},{xtype:"actioncolumn",width:120,align:"center",menuDisabled:true,menuText:"\u64cd\u4f5c",text:"\u64cd\u4f5c",items:[{iconCls:"x-cell-icon x-icon-edit",handler:function(b,c,a){editCellClick(b,c,a)}},{iconCls:"x-cell-icon x-icon-password",handler:function(b,c,a){resetCellClick(b,c,a)}},{iconCls:"x-cell-icon x-icon-delete",handler:function(b,c,a){deleteCellClick(b,c,a)}}]}],tbar:Ext.create("Ext.toolbar.Toolbar",{items:[{xtype:"button",text:"\u65b0\u589e\u7528\u6237",glyph:61441,handler:function(b,c){var a=Ext.getCmp("saveForm").getForm();a.load({url:"/Account/GetUser",params:{id:"",action:$$iPems.Action.Add},waitMsg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...",waitTitle:"\u7cfb\u7edf\u63d0\u793a",success:function(g,h){g.clearInvalid();Ext.getCmp("saveResult").setTextWithIcon("","");var f=Ext.getCmp("uid"),e=Ext.getCmp("password"),d=Ext.getCmp("confirmPassword");f.setReadOnly(false);e.enable();e.show();d.reset();d.enable();d.show();saveWnd.setGlyph(61441);saveWnd.setTitle("\u65b0\u589e\u7528\u6237");saveWnd.opaction=$$iPems.Action.Add;saveWnd.show()}})}},"-",Ext.create("Ext.ux.MultiCombo",{id:"roles-multicombo",fieldLabel:"\u89d2\u8272\u540d\u79f0",valueField:"id",displayField:"text",delimiter:$$iPems.Delimiter,queryMode:"local",triggerAction:"all",selectionMode:"all",emptyText:"\u9ed8\u8ba4\u5168\u90e8",forceSelection:true,labelWidth:60,width:250,store:multiComboRoleStore}),{id:"names-textbox",xtype:"textfield",fieldLabel:"\u7528\u6237\u540d\u79f0",labelWidth:60,width:250,maxLength:100,emptyText:"\u591a\u6761\u4ef6\u8bf7\u4ee5;\u5206\u9694\uff0c\u4f8b: A;B;C"},{xtype:"button",text:"\u6570\u636e\u67e5\u8be2",glyph:61445,handler:function(d,g){var b=Ext.getCmp("roles-multicombo"),h=Ext.getCmp("names-textbox");if(b.isValid()&&h.isValid()){var c=b.getSelectedValues(),a=h.getRawValue(),f=!Ext.isEmpty(a)?a.split($$iPems.Delimiter):[];currentStore.getProxy().extraParams.roles=c;currentStore.getProxy().extraParams.names=f;currentStore.loadPage(1)}}},"-",{xtype:"button",text:"\u6570\u636e\u5bfc\u51fa",glyph:61456,handler:function(a,b){$$iPems.download({url:"/Account/DownloadUsers",params:currentStore.getProxy().extraParams})}}]}),bbar:currentPagingToolbar});Ext.onReady(function(){var a=Ext.getCmp("center-content-panel-fw");if(!Ext.isEmpty(a)){a.add(currentGridPanel);currentStore.load();comboRoleStore.load();multiComboRoleStore.load()}});
