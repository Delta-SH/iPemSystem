(function(){Ext.define("NoticeModel",{extend:"Ext.data.Model",fields:[{name:"index",type:"int"},{name:"id",type:"string"},{name:"title",type:"string"},{name:"content",type:"string"},{name:"created",type:"string"},{name:"enabled",type:"boolean"}],idProperty:"id"});var g=function(j){var i=Ext.getCmp("begin-datefield").getRawValue(),k=Ext.getCmp("end-datefield").getRawValue();j.getProxy().extraParams.startDate=i;j.getProxy().extraParams.endDate=k;j.loadPage(1)};var a=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:20,model:"NoticeModel",proxy:{type:"ajax",url:"/Account/GetNotices",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},extraParams:{startDate:"",endDate:""},listeners:{exception:function(k,j,i){Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:i.getError(),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}},simpleSortMode:true}});var e=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:1024,fields:[{name:"id",type:"string"},{name:"text",type:"string"},{name:"comment",type:"string"}],proxy:{type:"ajax",url:"/Account/GetComboRoles",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"}}});var f=$$iPems.clonePagingToolbar(a);var h=Ext.create("Ext.window.Window",{title:"Detail",glyph:61477,height:400,width:500,modal:true,border:false,hidden:true,closeAction:"hide",opaction:$$iPems.Action.Add,items:[{xtype:"form",itemId:"saveForm",border:false,defaultType:"textfield",fieldDefaults:{labelWidth:60,labelAlign:"left",margin:"15 15 15 15",anchor:"100%"},items:[{itemId:"id",name:"id",xtype:"hidden",value:""},{itemId:"title",name:"title",xtype:"textfield",fieldLabel:"\u6d88\u606f\u6807\u9898",maxLength:256,enforceMaxLength:true,allowBlank:false},{itemId:"content",name:"content",xtype:"textareafield",autoScroll:true,height:150,fieldLabel:"\u8be6\u7ec6\u4fe1\u606f",allowBlank:false},Ext.create("Ext.ux.MultiCombo",{itemId:"toRoles",fieldLabel:"\u5e7f\u64ad\u5bf9\u8c61",valueField:"id",displayField:"text",delimiter:$$iPems.Delimiter,queryMode:"local",triggerAction:"all",selectionMode:"all",emptyText:"\u9ed8\u8ba4\u5168\u90e8",forceSelection:true,store:e,submitValue:false}),{itemId:"enabled",name:"enabled",xtype:"checkboxfield",fieldLabel:"\u6d88\u606f\u72b6\u6001",boxLabel:"(\u52fe\u9009\u8868\u793a\u542f\u7528)",inputValue:true,checked:false}]}],buttonAlign:"right",buttons:[{id:"saveResult",xtype:"iconlabel",text:""},{xtype:"tbfill"},{xtype:"button",text:"\u4fdd\u5b58",handler:function(k,n){var l=h.getComponent("saveForm"),m=l.getForm(),i=Ext.getCmp("saveResult");i.setTextWithIcon("","");if(m.isValid()){i.setTextWithIcon("\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...","x-icon-loading");var o=l.getComponent("toRoles"),j=o.getSelectedValues();m.submit({clientValidation:true,submitEmptyText:false,preventWindow:true,url:"/Account/SaveNotice",params:{action:h.opaction,roles:j},success:function(p,q){i.setTextWithIcon(q.result.message,"x-icon-accept");if(h.opaction==$$iPems.Action.Add){a.loadPage(1)}else{f.doRefresh()}},failure:function(q,r){var p="undefined error.";if(!Ext.isEmpty(r.result)&&!Ext.isEmpty(r.result.message)){p=r.result.message}i.setTextWithIcon(p,"x-icon-error")}})}else{i.setTextWithIcon("\u8868\u5355\u586b\u5199\u9519\u8bef","x-icon-error")}}},{xtype:"button",text:"\u5173\u95ed",handler:function(i,j){h.hide()}}]});var c=function(l,m,k){var i=l.getStore().getAt(m);if(Ext.isEmpty(i)){return false}var j=h.getComponent("saveForm").getForm();j.load({url:"/Account/GetNotice",params:{id:i.raw.id,action:$$iPems.Action.Edit},waitMsg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...",waitTitle:"\u7cfb\u7edf\u63d0\u793a",success:function(n,o){n.clearInvalid();Ext.getCmp("saveResult").setTextWithIcon("","");h.setTitle("\u7f16\u8f91\u6d88\u606f");h.opaction=$$iPems.Action.Edit;h.show()}})};var b=function(k,l,j){var i=k.getStore().getAt(l);if(Ext.isEmpty(i)){return false}Ext.Msg.confirm("\u786e\u8ba4\u5bf9\u8bdd\u6846","\u60a8\u786e\u8ba4\u8981\u5220\u9664\u5417\uff1f",function(m,n){if(m==="yes"){Ext.Ajax.request({url:"/Account/DeleteNotice",params:{id:i.raw.id},mask:new Ext.LoadMask(k,{msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(o,p){var q=Ext.decode(o.responseText,true);if(q.success){f.doRefresh()}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:q.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}})};var d=Ext.create("Ext.grid.Panel",{glyph:61477,title:"\u7cfb\u7edf\u6d88\u606f",region:"center",store:a,columnLines:true,disableSelection:false,loadMask:true,forceFit:false,listeners:{},viewConfig:{forceFit:true,trackOver:true,stripeRows:true,emptyText:'<h1 style="margin:20px">\u6ca1\u6709\u6570\u636e\u8bb0\u5f55</h1>',preserveScrollOnRefresh:true},columns:[{text:"\u5e8f\u53f7",dataIndex:"index",width:60,align:"left",sortable:true},{text:"\u6d88\u606f\u6807\u9898",dataIndex:"title",width:150,align:"left",sortable:true},{text:"\u8be6\u7ec6\u4fe1\u606f",dataIndex:"content",flex:1,align:"left",sortable:false,renderer:function(n,l,j,o,m,k,i){l.tdAttr=Ext.String.format("data-qtip='{0}'",n);return n}},{text:"\u6d88\u606f\u65e5\u671f",dataIndex:"created",width:150,align:"center",sortable:true},{text:"\u6d88\u606f\u72b6\u6001",dataIndex:"enabled",width:80,align:"center",sortable:true,renderer:function(i){return i?"\u6709\u6548":"\u7981\u7528"}},{xtype:"actioncolumn",width:80,align:"center",menuDisabled:true,menuText:"\u64cd\u4f5c",text:"\u64cd\u4f5c",items:[{iconCls:"x-cell-icon x-icon-edit",handler:function(j,k,i){c(j,k,i)}},{iconCls:"x-cell-icon x-icon-delete",handler:function(j,k,i){b(j,k,i)}}]}],tbar:Ext.create("Ext.toolbar.Toolbar",{items:[{xtype:"button",text:"\u65b0\u589e\u6d88\u606f",glyph:61441,handler:function(j,k){var i=h.getComponent("saveForm").getForm();i.load({url:"/Account/GetNotice",params:{id:"",action:$$iPems.Action.Add},waitMsg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...",waitTitle:"\u7cfb\u7edf\u63d0\u793a",success:function(l,m){l.clearInvalid();Ext.getCmp("saveResult").setTextWithIcon("","");h.setTitle("\u65b0\u589e\u6d88\u606f");h.opaction=$$iPems.Action.Add;h.show()}})}},"-",{id:"begin-datefield",xtype:"datefield",fieldLabel:"\u5f00\u59cb\u65e5\u671f",labelWidth:60,width:250,value:Ext.Date.add(new Date(),Ext.Date.DAY,-1),editable:false,allowBlank:false},{id:"end-datefield",xtype:"datefield",fieldLabel:"\u7ed3\u675f\u65e5\u671f",labelWidth:60,width:250,value:new Date(),editable:false,allowBlank:false},{xtype:"button",text:"\u6570\u636e\u67e5\u8be2",glyph:61445,handler:function(i,j){g(a)}}]}),bbar:f});Ext.onReady(function(){var i=Ext.getCmp("center-content-panel-fw");if(!Ext.isEmpty(i)){i.add(d);e.load();g(a)}})})();
