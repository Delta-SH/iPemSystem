Ext.define("RoleModel",{extend:"Ext.data.Model",fields:[{name:"index",type:"int"},{name:"id",type:"string"},{name:"name",type:"string"},{name:"comment",type:"string"},{name:"enabled",type:"boolean"}],idProperty:"id"});var currentStore=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:20,model:"RoleModel",proxy:{type:"ajax",url:"/Account/GetRoles",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},listeners:{exception:function(c,b,a){Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:a.getError(),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}},extraParams:{condition:""},simpleSortMode:true}});var menuStore=Ext.create("Ext.data.TreeStore",{autoLoad:false,root:{id:-10078,text:"\u7cfb\u7edf\u4e3b\u9875",icon:$$iPems.icons.Home,root:true},proxy:{type:"ajax",url:"/Account/GetAllMenus",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"}}});var areaStore=Ext.create("Ext.data.TreeStore",{autoLoad:false,root:{id:-10078,text:"\u7cfb\u7edf\u4e3b\u9875",icon:$$iPems.icons.Home,root:true},proxy:{type:"ajax",url:"/Account/GetAllAreas",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"}}});var operateStore=Ext.create("Ext.data.TreeStore",{autoLoad:false,root:{id:-10078,text:"\u7cfb\u7edf\u4e3b\u9875",icon:$$iPems.icons.Home,root:true},proxy:{type:"ajax",url:"/Account/GetAllOperates",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"}}});var currentPagingToolbar=$$iPems.clonePagingToolbar(currentStore);var saveWnd=Ext.create("Ext.window.Window",{title:"Role",height:400,width:600,modal:true,border:false,hidden:true,closeAction:"hide",opaction:$$iPems.Action.Add,layout:{type:"hbox",align:"stretch"},items:[{id:"saveForm",xtype:"form",margin:"5 5 5 5",flex:2,border:false,defaultType:"textfield",defaults:{anchor:"100%"},fieldDefaults:{labelWidth:60,labelAlign:"left",flex:1,margin:"10 5 10 5"},items:[{id:"id",name:"id",xtype:"textfield",fieldLabel:"\u89d2\u8272\u6807\u8bc6",allowBlank:false,readOnly:true,labelAlign:"top"},{id:"name",name:"name",xtype:"textfield",fieldLabel:"\u89d2\u8272\u540d\u79f0",allowBlank:false,labelAlign:"top"},{id:"comment",name:"comment",xtype:"textareafield",fieldLabel:"\u89d2\u8272\u5907\u6ce8",height:100,labelAlign:"top"},{id:"enabled",name:"enabled",xtype:"checkboxfield",fieldLabel:"\u89d2\u8272\u72b6\u6001",boxLabel:"(\u52fe\u9009\u8868\u793a\u542f\u7528)",inputValue:true,checked:false,labelAlign:"top"}]},{xtype:"tabpanel",flex:3,margin:"5 5 5 5",activeTab:0,plain:true,defaults:{autoScroll:true,border:false,useArrows:false,rootVisible:false,},items:[{id:"treeMenus",xtype:"treepanel",title:"\u83dc\u5355\u6743\u9650",glyph:61457,store:menuStore,listeners:{load:function(b,c,a,d){if(d){this.getRootNode().expand(false)}},checkchange:function(b,a){b.eachChild(function(d){d.cascadeBy(function(c){c.set("checked",a)})})}}},{id:"areaMenus",xtype:"treepanel",title:"\u533a\u57df\u6743\u9650",glyph:61465,store:areaStore,listeners:{load:function(b,c,a,d){if(d){this.getRootNode().expand(false)}},checkchange:function(b,a){b.eachChild(function(d){d.cascadeBy(function(c){c.set("checked",a)})})}}},{id:"operateMenus",xtype:"treepanel",title:"\u64cd\u4f5c\u6743\u9650",glyph:61480,store:operateStore,listeners:{load:function(b,c,a,d){if(d){this.getRootNode().expand(false)}},checkchange:function(b,a){b.eachChild(function(d){d.cascadeBy(function(c){c.set("checked",a)})})}}}]}],buttons:[{id:"saveResult",xtype:"iconlabel",text:""},{xtype:"tbfill"},{xtype:"button",text:"\u4fdd\u5b58",handler:function(d,i){var b=Ext.getCmp("saveForm").getForm(),k=Ext.getCmp("saveResult");k.setTextWithIcon("","");if(b.isValid()){var g=Ext.getCmp("treeMenus").getChecked();if(g.length===0){k.setTextWithIcon("\u8bf7\u9009\u62e9\u89d2\u8272\u7684\u83dc\u5355\u6743\u9650...","x-icon-error");return false}var a=Ext.getCmp("areaMenus").getChecked();if(a.length===0){k.setTextWithIcon("\u8bf7\u9009\u62e9\u89d2\u8272\u7684\u533a\u57df\u6743\u9650...","x-icon-error");return false}var j=Ext.getCmp("operateMenus").getChecked();var c=[];g.forEach(function(e){c.push(e.data.id)});var h=[];a.forEach(function(e){h.push(e.data.id)});var f=[];j.forEach(function(e){f.push(e.data.id)});k.setTextWithIcon("\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...","x-icon-loading");b.submit({submitEmptyText:false,clientValidation:true,preventWindow:true,url:"/Account/SaveRole",params:{menus:c,areas:h,operates:f,action:saveWnd.opaction},success:function(e,l){k.setTextWithIcon(l.result.message,"x-icon-accept");if(saveWnd.opaction==$$iPems.Action.Add){currentStore.loadPage(1)}else{currentPagingToolbar.doRefresh()}},failure:function(l,m){var e="undefined error.";if(!Ext.isEmpty(m.result)&&!Ext.isEmpty(m.result.message)){e=m.result.message}k.setTextWithIcon(e,"x-icon-error")}})}else{k.setTextWithIcon("\u8868\u5355\u586b\u5199\u9519\u8bef","x-icon-error")}}},{xtype:"button",text:"\u5173\u95ed",handler:function(a,b){saveWnd.close()}}]});var editCellClick=function(d,e,c){var a=d.getStore().getAt(e);if(Ext.isEmpty(a)){return false}var b=Ext.getCmp("saveForm").getForm();b.load({url:"/Account/GetRole",params:{id:a.raw.id,action:$$iPems.Action.Edit},waitMsg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...",waitTitle:"\u7cfb\u7edf\u63d0\u793a",success:function(k,l){k.clearInvalid();Ext.getCmp("name").setReadOnly(true);Ext.getCmp("saveResult").setTextWithIcon("","");var h=[];if(!Ext.isEmpty(l.result.data.menus)){h=l.result.data.menus}var j=[];if(!Ext.isEmpty(l.result.data.areas)){j=l.result.data.areas}var i=[];if(!Ext.isEmpty(l.result.data.operates)){i=l.result.data.operates}var g=Ext.getCmp("treeMenus").getRootNode();if(g.hasChildNodes()){g.eachChild(function(n){n.cascadeBy(function(p){var o=Ext.Array.contains(h,p.data.id);p.set("checked",o)})})}var f=Ext.getCmp("areaMenus").getRootNode();if(f.hasChildNodes()){f.eachChild(function(n){n.cascadeBy(function(p){var o=Ext.Array.contains(j,p.data.id);p.set("checked",o)})})}var m=Ext.getCmp("operateMenus").getRootNode();if(m.hasChildNodes()){m.eachChild(function(n){n.cascadeBy(function(p){var o=Ext.Array.contains(i,p.data.id);p.set("checked",o)})})}saveWnd.setGlyph(61442);saveWnd.setTitle("\u7f16\u8f91\u89d2\u8272");saveWnd.opaction=$$iPems.Action.Edit;saveWnd.show()}})};var deleteCellClick=function(c,d,b){var a=c.getStore().getAt(d);if(Ext.isEmpty(a)){return false}Ext.Msg.confirm("\u786e\u8ba4\u5bf9\u8bdd\u6846","\u60a8\u786e\u8ba4\u8981\u5220\u9664\u5417\uff1f",function(e,f){if(e==="yes"){Ext.Ajax.request({url:"/Account/DeleteRole",params:{id:a.raw.id},mask:new Ext.LoadMask(c,{msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(g,h){var i=Ext.decode(g.responseText,true);if(i.success){currentPagingToolbar.doRefresh()}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:i.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}})};var currentGridPanel=Ext.create("Ext.grid.Panel",{glyph:61491,title:"\u7cfb\u7edf\u89d2\u8272\u4fe1\u606f",region:"center",store:currentStore,columnLines:true,disableSelection:false,loadMask:true,forceFit:true,listeners:{},viewConfig:{forceFit:true,trackOver:true,stripeRows:true,emptyText:'<h1 style="margin:20px">\u6ca1\u6709\u6570\u636e\u8bb0\u5f55</h1>',preserveScrollOnRefresh:true},columns:[{text:"\u5e8f\u53f7",dataIndex:"index",width:60,align:"left",sortable:true},{text:"\u89d2\u8272\u6807\u8bc6",dataIndex:"id",width:150,align:"center",sortable:false},{text:"\u89d2\u8272\u540d\u79f0",dataIndex:"name",align:"center",width:150,sortable:true},{text:"\u89d2\u8272\u5907\u6ce8",dataIndex:"comment",flex:1,align:"left",sortable:true},{text:"\u89d2\u8272\u72b6\u6001",dataIndex:"enabled",width:100,align:"center",sortable:true,renderer:function(a){return a?"\u6709\u6548":"\u7981\u7528"}},{xtype:"actioncolumn",width:100,align:"center",menuDisabled:true,menuText:"\u64cd\u4f5c",text:"\u64cd\u4f5c",items:[{iconCls:"x-cell-icon x-icon-edit",handler:function(b,c,a){editCellClick(b,c,a)}},{iconCls:"x-cell-icon x-icon-delete",handler:function(b,c,a){deleteCellClick(b,c,a)}}]}],tbar:Ext.create("Ext.toolbar.Toolbar",{items:[{xtype:"button",text:"\u65b0\u589e\u89d2\u8272",glyph:61441,handler:function(b,c){var a=Ext.getCmp("saveForm").getForm();a.load({url:"/Account/GetRole",params:{id:"",action:$$iPems.Action.Add},waitMsg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...",waitTitle:"\u7cfb\u7edf\u63d0\u793a",success:function(i,j){i.clearInvalid();Ext.getCmp("name").setReadOnly(false);Ext.getCmp("saveResult").setTextWithIcon("","");var f=[];if(!Ext.isEmpty(j.result.data.menus)){f=j.result.data.menus}var h=[];if(!Ext.isEmpty(j.result.data.areas)){h=j.result.data.areas}var g=[];if(!Ext.isEmpty(j.result.data.operates)){g=j.result.data.operates}var e=Ext.getCmp("treeMenus").getRootNode();if(e.hasChildNodes()){e.eachChild(function(l){l.cascadeBy(function(o){var m=Ext.Array.contains(f,o.data.id);o.set("checked",m)})})}var d=Ext.getCmp("areaMenus").getRootNode();if(d.hasChildNodes()){d.eachChild(function(l){l.cascadeBy(function(o){var m=Ext.Array.contains(h,o.data.id);o.set("checked",m)})})}var k=Ext.getCmp("operateMenus").getRootNode();if(k.hasChildNodes()){k.eachChild(function(l){l.cascadeBy(function(o){var m=Ext.Array.contains(g,o.data.id);o.set("checked",m)})})}saveWnd.setGlyph(61441);saveWnd.setTitle("\u65b0\u589e\u89d2\u8272");saveWnd.opaction=$$iPems.Action.Add;saveWnd.show()}})}},"-",{xtype:"textfield",id:"namesfield",fieldLabel:"\u89d2\u8272\u540d\u79f0",labelWidth:60,width:250,maxLength:100,emptyText:"\u591a\u6761\u4ef6\u8bf7\u4ee5;\u5206\u9694\uff0c\u4f8b: A;B;C"},{xtype:"button",text:"\u6570\u636e\u67e5\u8be2",glyph:61445,handler:function(a,b){var c=Ext.getCmp("namesfield");if(!Ext.isEmpty(c)&&c.isValid()){currentStore.getProxy().extraParams.condition=c.getRawValue();currentStore.loadPage(1)}}},"-",{xtype:"button",text:"\u6570\u636e\u5bfc\u51fa",glyph:61456,handler:function(a,b){$$iPems.download({url:"/Account/DownloadRoles",params:{condition:currentStore.getProxy().extraParams.condition}})}}]}),bbar:currentPagingToolbar});Ext.onReady(function(){var a=Ext.getCmp("center-content-panel-fw");if(!Ext.isEmpty(a)){a.add(currentGridPanel);currentStore.load();menuStore.load();areaStore.load();operateStore.load()}});
