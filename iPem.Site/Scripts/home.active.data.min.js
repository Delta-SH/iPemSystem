(function(){var g=null,a=null,c={tooltip:{formatter:"{a}: {c} {b}"},series:[{name:"\u5b9e\u65f6\u6d4b\u503c",type:"gauge",center:["50%",100],radius:"100%",title:{offsetCenter:[0,-30],textStyle:{color:"#005eaa",fontWeight:"bolder",fontSize:16}},detail:{offsetCenter:[0,30],textStyle:{fontSize:18}},data:[{value:0,name:"kW\u00b7h"}]}]},e={tooltip:{trigger:"axis",formatter:"{b}: {c} {a}"},grid:{top:15,left:0,right:5,bottom:0,containLabel:true},xAxis:[{type:"category",boundaryGap:false,splitLine:{show:false},data:[]}],yAxis:[{type:"value"}],series:[{name:"kW\u00b7h",type:"line",smooth:true,symbol:"none",sampling:"average",itemStyle:{normal:{color:"#0892cd"}},areaStyle:{normal:{}},data:[]}]};var j=function(){c.series[0].min=0;c.series[0].max=100;c.series[0].data[0].value=0;c.series[0].data[0].name="kW\u00b7h";g.setOption(c,true);e.series[0].name="kW\u00b7h";e.series[0].data=[];e.xAxis[0].data=[];a.setOption(e,true)};var f=function(m){if(m!=null){var l=60,p=m.get("timestamp"),o=m.get("value"),n=m.get("unit");if(o>=0){if(o<=100){c.series[0].min=0;c.series[0].max=100}else{if(o>100&&o<=500){c.series[0].min=0;c.series[0].max=500}else{if(o>500&&o<=1000){c.series[0].min=0;c.series[0].max=1000}else{if(o>1000&&o<=5000){c.series[0].min=0;c.series[0].max=5000}else{c.series[0].min=0;c.series[0].max=10000}}}}}else{if(o>=-100){c.series[0].min=-100;c.series[0].max=0}else{if(o<-100&&o>=-500){c.series[0].min=-500;c.series[0].max=0}else{if(o<-500&&o>=-1000){c.series[0].min=-1000;c.series[0].max=0}else{if(o<-1000&&o>=-5000){c.series[0].min=-5000;c.series[0].max=0}else{c.series[0].min=-10000;c.series[0].max=0}}}}}c.series[0].data[0].name=n;c.series[0].data[0].value=o;g.setOption(c,true);if(e.series[0].data.length>l){e.series[0].data.shift();e.xAxis[0].data.shift()}e.series[0].name=n;e.series[0].data.push(o);e.xAxis[0].data.push(p);a.setOption(e,true)}};Ext.define("PointModel",{extend:"Ext.data.Model",fields:[{name:"index",type:"int"},{name:"area",type:"string"},{name:"station",type:"string"},{name:"room",type:"string"},{name:"device",type:"string"},{name:"point",type:"string"},{name:"type",type:"string"},{name:"value",type:"float"},{name:"unit",type:"string"},{name:"status",type:"string"},{name:"time",type:"string"},{name:"devid",type:"string"},{name:"pointid",type:"string"},{name:"typeid",type:"int"},{name:"statusid",type:"int"},{name:"rsspoint",type:"boolean"},{name:"rssfrom",type:"boolean"},{name:"timestamp",type:"string"}],idProperty:"index"});var h=function(p,l){var o=l.store,q=p.getId(),n=$$iPems.SplitKeys(q),m=Ext.getCmp("points-grid").columns;if(q!=="root"&&n.length===2&&parseInt(n[0])===$$iPems.Organization.Device){m[1].hide();m[2].hide();m[3].hide();m[4].hide()}else{m[1].show();m[2].show();m[3].show();m[4].show()}j();o.proxy.extraParams.node=p.getId();o.loadPage(1)};var k=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:20,model:"PointModel",groupField:"type",groupDir:"undefined",sortOnLoad:false,proxy:{type:"ajax",url:"/Home/RequestActPoints",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},extraParams:{node:"root",types:[$$iPems.Point.DI,$$iPems.Point.AI,$$iPems.Point.AO,$$iPems.Point.DO]},simpleSortMode:true},listeners:{load:function(q,m,r){if(r&&g&&a){if(m.length>0){var o=Ext.getCmp("points-grid"),p=o.getSelectionModel();if(p.hasSelection()){var n=p.getSelection()[0].get("index");var l=q.findRecord("index",n);if(l!=null){f(l)}}}$$iPems.Tasks.actPointTask.fireOnStart=false;$$iPems.Tasks.actPointTask.restart()}}}});var i=$$iPems.clonePagingToolbar(k);var d=Ext.create("Ext.window.Window",{title:"\u4fe1\u53f7\u9065\u63a7\u53c2\u6570",height:250,width:400,glyph:61504,modal:true,border:false,hidden:true,closeAction:"hide",items:[{xtype:"form",itemId:"controlForm",border:false,padding:10,items:[{itemId:"device",xtype:"hiddenfield",name:"device"},{itemId:"point",xtype:"hiddenfield",name:"point"},{itemId:"controlradio",xtype:"radiogroup",columns:1,vertical:true,items:[{boxLabel:"\u5e38\u5f00\u63a7\u5236(0)",name:"ctrl",inputValue:0,checked:true},{boxLabel:"\u5e38\u95ed\u63a7\u5236(1)",name:"ctrl",inputValue:1},{boxLabel:"\u8109\u51b2\u63a7\u5236(2)",name:"ctrl",inputValue:2}]}]}],buttons:[{id:"controlResult",xtype:"iconlabel",text:""},{xtype:"tbfill"},{xtype:"button",text:"\u9065\u63a7",handler:function(m,p){var n=d.getComponent("controlForm"),o=n.getForm(),l=Ext.getCmp("controlResult");l.setTextWithIcon("","");if(o.isValid()){l.setTextWithIcon("\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...","x-icon-loading");o.submit({submitEmptyText:false,clientValidation:true,preventWindow:true,url:"/Home/ControlPoint",success:function(q,r){l.setTextWithIcon(r.result.message,"x-icon-accept")},failure:function(r,s){var q="undefined error.";if(!Ext.isEmpty(s.result)&&!Ext.isEmpty(s.result.message)){q=s.result.message}l.setTextWithIcon(q,"x-icon-error")}})}else{l.setTextWithIcon("\u8868\u5355\u586b\u5199\u9519\u8bef","x-icon-error")}}},{xtype:"button",text:"\u5173\u95ed",handler:function(l,o){var m=d.getComponent("controlForm"),n=m.getForm();n.reset();d.close()}}]});var b=Ext.create("Ext.window.Window",{title:"\u4fe1\u53f7\u9065\u8c03\u53c2\u6570",height:250,width:400,glyph:61480,modal:true,border:false,hidden:true,closeAction:"hide",items:[{xtype:"form",itemId:"adjustForm",border:false,padding:10,items:[{itemId:"device",xtype:"hiddenfield",name:"device"},{itemId:"point",xtype:"hiddenfield",name:"point"},{itemId:"adjust",xtype:"numberfield",name:"adjust",fieldLabel:"\u6a21\u62df\u91cf\u8f93\u51fa\u503c",value:0,width:280,allowOnlyWhitespace:false}]}],buttons:[{id:"adjustResult",xtype:"iconlabel",text:""},{xtype:"tbfill"},{xtype:"button",text:"\u9065\u8c03",handler:function(m,p){var n=b.getComponent("adjustForm"),o=n.getForm(),l=Ext.getCmp("adjustResult");l.setTextWithIcon("","");if(o.isValid()){l.setTextWithIcon("\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...","x-icon-loading");o.submit({submitEmptyText:false,clientValidation:true,preventWindow:true,url:"/Home/AdjustPoint",success:function(q,r){l.setTextWithIcon(r.result.message,"x-icon-accept")},failure:function(r,s){var q="undefined error.";if(!Ext.isEmpty(s.result)&&!Ext.isEmpty(s.result.message)){q=s.result.message}l.setTextWithIcon(q,"x-icon-error")}})}else{l.setTextWithIcon("\u8868\u5355\u586b\u5199\u9519\u8bef","x-icon-error")}}},{xtype:"button",text:"\u5173\u95ed",handler:function(l,o){var m=b.getComponent("adjustForm"),n=m.getForm();n.reset();b.close()}}]});Ext.onReady(function(){var m=Ext.create("Ext.panel.Panel",{id:"currentLayout",region:"center",layout:"border",border:false,items:[{id:"organization",region:"west",xtype:"treepanel",title:"\u7cfb\u7edf\u5c42\u7ea7\u5217\u8868",glyph:61457,width:220,split:true,collapsible:true,collapsed:false,autoScroll:true,useArrows:false,rootVisible:true,root:{id:"root",text:"\u5168\u90e8",expanded:true,icon:$$iPems.icons.Home},viewConfig:{loadMask:true},store:Ext.create("Ext.data.TreeStore",{autoLoad:false,nodeParam:"node",proxy:{type:"ajax",url:"/Component/GetDevices",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"}}}),listeners:{select:function(p,n,o){h(n,i)}},tbar:[{id:"organization-search-field",xtype:"textfield",emptyText:"\u8bf7\u8f93\u5165\u7b5b\u9009\u6761\u4ef6...",flex:1,listeners:{change:function(p,q,n,o){delete p._filterData;delete p._filterIndex}}},{id:"point-search-button",xtype:"button",glyph:61445,handler:function(){var n=Ext.getCmp("organization"),p=Ext.getCmp("organization-search-field"),r=p.getRawValue();if(Ext.isEmpty(r,false)){return}if(r.length<2){return}if(p._filterData!=null&&p._filterIndex!=null){var o=p._filterIndex+1;var q=p._filterData;if(o>=q.length){o=0;Ext.Msg.show({title:"\u7cfb\u7edf\u63d0\u793a",msg:"\u641c\u7d22\u5b8c\u6bd5",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}$$iPems.selectNodePath(n,q[o]);p._filterIndex=o}else{Ext.Ajax.request({url:"/Component/FilterRoomPath",params:{text:r},mask:new Ext.LoadMask({target:n,msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(t,u){var v=Ext.decode(t.responseText,true);if(v.success){var s=v.data.length;if(s>0){$$iPems.selectNodePath(n,v.data[0]);p._filterData=v.data;p._filterIndex=0}else{Ext.Msg.show({title:"\u7cfb\u7edf\u63d0\u793a",msg:Ext.String.format("\u672a\u627e\u5230\u6307\u5b9a\u5185\u5bb9:<br/>{0}",r),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:v.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}}}]},{region:"center",xtype:"panel",border:false,bodyCls:"x-border-body-panel",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"panel",glyph:61497,title:"\u4fe1\u53f7\u5b9e\u65f6\u56fe\u8868",collapsible:true,collapseFirst:false,layout:{type:"hbox",align:"stretch",pack:"start"},items:[{xtype:"container",flex:1,contentEl:"gauge-chart"},{xtype:"container",flex:3,contentEl:"line-chart"}]},{id:"points-grid",xtype:"grid",collapsible:true,collapseFirst:false,layout:"fit",margin:"5 0 0 0",flex:2,header:{glyph:61481,title:"\u4fe1\u53f7\u5b9e\u65f6\u6d4b\u503c",items:[{xtype:"checkboxgroup",width:240,items:[{xtype:"checkboxfield",boxLabel:"\u9065\u4fe1",inputValue:$$iPems.Point.DI,checked:true,boxLabelCls:"x-label-header x-form-cb-label"},{xtype:"checkboxfield",boxLabel:"\u9065\u6d4b",inputValue:$$iPems.Point.AI,checked:true,boxLabelCls:"x-label-header x-form-cb-label"},{xtype:"checkboxfield",boxLabel:"\u9065\u8c03",inputValue:$$iPems.Point.AO,checked:true,boxLabelCls:"x-label-header x-form-cb-label"},{xtype:"checkboxfield",boxLabel:"\u9065\u63a7",inputValue:$$iPems.Point.DO,checked:true,boxLabelCls:"x-label-header x-form-cb-label"},],listeners:{change:function(p,q,n){var o=[];Ext.Object.each(q,function(r,t,s){o.push(t)});k.proxy.extraParams.types=o;k.loadPage(1)}}}]},tools:[{type:"refresh",tooltip:"\u5237\u65b0",handler:function(p,o,n){i.doRefresh()}}],store:k,viewConfig:{loadMask:false,preserveScrollOnRefresh:true,stripeRows:true,trackOver:true,emptyText:'<h1 style="margin:20px">\u6ca1\u6709\u6570\u636e\u8bb0\u5f55</h1>',getRowClass:function(n,q,p,o){return $$iPems.GetPointStatusCls(n.get("statusid"))}},features:[{ftype:"grouping",groupHeaderTpl:"{columnName}: {name} ({rows.length}\u6761)",hideGroupedHeader:false,startCollapsed:false}],columns:[{text:"\u5e8f\u53f7",dataIndex:"index",width:60},{text:"\u6240\u5c5e\u533a\u57df",dataIndex:"area"},{text:"\u6240\u5c5e\u7ad9\u70b9",dataIndex:"station"},{text:"\u6240\u5c5e\u673a\u623f",dataIndex:"room"},{text:"\u6240\u5c5e\u8bbe\u5907",dataIndex:"device"},{text:"\u4fe1\u53f7\u540d\u79f0",dataIndex:"point"},{text:"\u4fe1\u53f7\u7c7b\u578b",dataIndex:"type"},{text:"\u4fe1\u53f7\u6d4b\u503c",dataIndex:"value"},{text:"\u5355\u4f4d/\u63cf\u8ff0",dataIndex:"unit"},{text:"\u4fe1\u53f7\u72b6\u6001",dataIndex:"status",tdCls:"x-status-cell",align:"center"},{text:"\u503c\u53d8\u65f6\u95f4",dataIndex:"time"},{xtype:"actioncolumn",width:100,align:"center",menuDisabled:true,menuText:"\u64cd\u4f5c",text:"\u64cd\u4f5c",items:[{tooltip:"\u9065\u63a7",getClass:function(o,q,s,t,p,n){return(s.get("typeid")===$$iPems.Point.DO&&$$iPems.ControlOperation)?"x-cell-icon x-icon-remote-control":"x-cell-icon x-icon-hidden"},handler:function(s,r,u,v,n,q){s.getSelectionModel().select(q);var o=d.getComponent("controlForm"),p=o.getComponent("device"),t=o.getComponent("point"),w=Ext.getCmp("controlResult");p.setValue(q.get("devid"));t.setValue(q.get("pointid"));w.setTextWithIcon("","");d.show()}},{tooltip:"\u9065\u8c03",getClass:function(o,q,s,t,p,n){return(s.get("typeid")===$$iPems.Point.AO&&$$iPems.AdjustOperation)?"x-cell-icon x-icon-remote-setting":"x-cell-icon x-icon-hidden"},handler:function(s,r,u,v,n,q){s.getSelectionModel().select(q);var o=b.getComponent("adjustForm"),p=o.getComponent("device"),t=o.getComponent("point"),w=Ext.getCmp("adjustResult");p.setValue(q.get("devid"));t.setValue(q.get("pointid"));w.setTextWithIcon("","");b.show()}},{getTip:function(o,q,s,t,p,n){return(s.get("rsspoint")===true)?"\u5df2\u5173\u6ce8":"\u5173\u6ce8"},getClass:function(o,q,s,t,p,n){return(s.get("rssfrom")===false)?((s.get("rsspoint")===true)?"x-cell-icon x-icon-tick":"x-cell-icon x-icon-add"):"x-cell-icon x-icon-hidden"},handler:function(o,s,p,r,q,n){if(n.get("rsspoint")){return false}Ext.Ajax.request({url:"/Home/AddRssPoint",params:{device:n.get("devid"),point:n.get("pointid")},mask:new Ext.LoadMask({target:o,msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(t,u){var v=Ext.decode(t.responseText,true);if(v.success){i.doRefresh()}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:v.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}},{tooltip:"\u53d6\u6d88\u5173\u6ce8",getClass:function(o,q,s,t,p,n){return(s.get("rssfrom")===true)?"x-cell-icon x-icon-delete":"x-cell-icon x-icon-hidden"},handler:function(o,s,p,r,q,n){Ext.Ajax.request({url:"/Home/RemoveRssPoint",params:{device:n.get("devid"),point:n.get("pointid")},mask:new Ext.LoadMask({target:o,msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(t,u){var v=Ext.decode(t.responseText,true);if(v.success){i.doRefresh()}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:v.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}}]}],bbar:i,listeners:{selectionchange:function(n,o){j();if(o.length>0){f(o[0])}}}}]}]});$$iPems.Tasks.actPointTask.run=function(){i.doRefresh()};$$iPems.Tasks.actPointTask.start();var l=Ext.getCmp("center-content-panel-fw");if(!Ext.isEmpty(l)){l.add(m)}});Ext.onReady(function(){g=echarts.init(document.getElementById("gauge-chart"),"shine");a=echarts.init(document.getElementById("line-chart"),"shine");g.setOption(c);a.setOption(e)})})();
