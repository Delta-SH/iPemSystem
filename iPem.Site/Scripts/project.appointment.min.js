Ext.define("AppointmentModel",{extend:"Ext.data.Model",fields:[{name:"index",type:"int"},{name:"id",type:"string"},{name:"startDate",type:"string"},{name:"endDate",type:"string"},{name:"projectName",type:"string"},{name:"projectId",type:"string"},{name:"creator",type:"string"},{name:"createdTime",type:"string"},{name:"comment",type:"string"},{name:"enabled",type:"boolean"}],idProperty:"id"});var query=function(b){var f=Ext.getCmp("start-datefield").getRawValue(),a=Ext.getCmp("end-datefield").getRawValue(),d=Ext.getCmp("type-combobox").getValue(),e=Ext.getCmp("keyword-textbox").getRawValue();var c=b.getProxy();c.extraParams.startDate=f;c.extraParams.endDate=a;c.extraParams.type=d;c.extraParams.keyWord=e;currentStore.loadPage(1)};var download=function(a){var b=a.getProxy().extraParams;$$iPems.download({url:"/Project/DownloadAppointments",params:b})};var currentStore=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:20,model:"AppointmentModel",proxy:{type:"ajax",url:"/Project/GetAppointments",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},listeners:{exception:function(c,b,a){Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:a.getError(),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}},simpleSortMode:true}});var typeStore=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"int"},{name:"name",type:"string"}],data:[{id:-1,name:"\u6309\u5de5\u7a0b\u540d\u79f0"},{id:$$iPems.Organization.Area,name:"\u6309\u533a\u57df\u540d\u79f0"},{id:$$iPems.Organization.Station,name:"\u6309\u7ad9\u70b9\u540d\u79f0"},{id:$$iPems.Organization.Room,name:"\u6309\u673a\u623f\u540d\u79f0"},{id:$$iPems.Organization.Device,name:"\u6309\u8bbe\u5907\u540d\u79f0"}]});var projectStore=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:1024,fields:[{name:"id",type:"string"},{name:"text",type:"string"},{name:"comment",type:"string"}],proxy:{type:"ajax",url:"/Project/GetComboProjects",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"}},listeners:{load:function(b,a,c){if(c&&!Ext.isEmpty(a)&&a.length>0){Ext.getCmp("projectId").select(a[0])}}}});var currentPagingToolbar=$$iPems.clonePagingToolbar(currentStore);var submit=function(c,b,a){a.setTextWithIcon("\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...","x-icon-loading");c.submit({submitEmptyText:false,clientValidation:true,preventWindow:true,url:"/Project/SaveAppointment",params:{nodes:b,action:saveWnd.opaction},success:function(d,e){a.setTextWithIcon(e.result.message,"x-icon-accept");if(saveWnd.opaction==$$iPems.Action.Add){currentStore.loadPage(1)}else{currentPagingToolbar.doRefresh()}},failure:function(e,f){var d="undefined error.";if(!Ext.isEmpty(f.result)&&!Ext.isEmpty(f.result.message)){d=f.result.message}a.setTextWithIcon(d,"x-icon-error")}})};var detailWnd=Ext.create("Ext.window.Window",{title:"\u9884\u7ea6\u8be6\u60c5",glyph:61509,height:250,width:400,modal:true,border:false,hidden:true,closeAction:"hide",bodyPadding:10,layout:"form",defaultType:"displayfield",items:[{itemId:"detail_area",labelWidth:60,fieldLabel:"\u9884\u7ea6\u533a\u57df"},{itemId:"detail_station",labelWidth:60,fieldLabel:"\u9884\u7ea6\u7ad9\u70b9"},{itemId:"detail_room",labelWidth:60,fieldLabel:"\u9884\u7ea6\u673a\u623f"},{itemId:"detail_device",labelWidth:60,fieldLabel:"\u9884\u7ea6\u8bbe\u5907"}],buttonAlign:"right",buttons:[{xtype:"button",text:"\u5173\u95ed",handler:function(a,b){detailWnd.hide()}}]});var saveWnd=Ext.create("Ext.window.Window",{title:"Role",height:400,width:600,modal:true,border:false,hidden:true,closeAction:"hide",opaction:$$iPems.Action.Add,layout:{type:"hbox",align:"stretch"},items:[{id:"saveForm",xtype:"form",flex:2,border:false,defaultType:"textfield",defaults:{anchor:"100%"},fieldDefaults:{labelWidth:60,labelAlign:"top",margin:10},items:[{id:"id",name:"id",xtype:"hiddenfield",value:""},{id:"projectId",name:"projectId",xtype:"combobox",fieldLabel:"\u5de5\u7a0b\u540d\u79f0",store:projectStore,displayField:"text",valueField:"id",typeAhead:true,queryMode:"local",triggerAction:"all",selectOnFocus:true,forceSelection:true,allowBlank:false},{id:"startDate",name:"startDate",xtype:"datetimepicker",fieldLabel:"\u5f00\u59cb\u65f6\u95f4",editable:false,allowBlank:false},{id:"endDate",name:"endDate",xtype:"datetimepicker",fieldLabel:"\u7ed3\u675f\u65f6\u95f4",editable:false,allowBlank:false},{id:"comment",name:"comment",xtype:"textareafield",fieldLabel:"\u5907\u6ce8\u4fe1\u606f",height:70},{id:"enabled",name:"enabled",xtype:"checkboxfield",fieldLabel:"\u9884\u7ea6\u72b6\u6001",boxLabel:"(\u52fe\u9009\u8868\u793a\u542f\u7528)",inputValue:true,checked:false}]},{id:"organization",xtype:"treepanel",flex:3,margin:"10 10 10 0",glyph:61457,autoScroll:true,useArrows:false,rootVisible:false,root:{id:"root",text:"\u5168\u90e8",icon:$$iPems.icons.Home,expanded:true},viewConfig:{loadMask:true},store:Ext.create("Ext.data.TreeStore",{autoLoad:false,proxy:{type:"ajax",url:"/Component/GetDevices",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},extraParams:{multiselect:true,leafselect:false}}}),tbar:[{id:"organization-search-field",xtype:"textfield",emptyText:"\u8bf7\u8f93\u5165\u7b5b\u9009\u6761\u4ef6...",flex:1,listeners:{change:function(c,d,a,b){delete c._filterData;delete c._filterIndex}}},{xtype:"button",glyph:61445,handler:function(){var i=Ext.getCmp("organization"),h=Ext.getCmp("organization-search-field"),e=h.getRawValue(),b="/",d=i.getRootNode();if(Ext.isEmpty(e,false)){return}if(e.length<2){return}if(h._filterData!=null&&h._filterIndex!=null){var c=h._filterIndex+1;var g=h._filterData;if(c>=g.length){c=0;Ext.Msg.show({title:"\u7cfb\u7edf\u63d0\u793a",msg:"\u641c\u7d22\u5b8c\u6bd5",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}var a=Ext.Array.from(g[c]);var f=Ext.String.format("{0}{1}{0}{2}",b,d.getId(),a.join(b));i.selectPath(f);h._filterIndex=c}else{Ext.Ajax.request({url:"/Component/FilterRoomPath",params:{text:e},mask:new Ext.LoadMask({target:i,msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(l,m){var n=Ext.decode(l.responseText,true);if(n.success){var j=n.data.length;if(j>0){var k=Ext.Array.from(n.data[0]);var o=Ext.String.format("{0}{1}{0}{2}",b,d.getId(),k.join(b));i.selectPath(o);h._filterData=n.data;h._filterIndex=0}else{Ext.Msg.show({title:"\u7cfb\u7edf\u63d0\u793a",msg:Ext.String.format("\u672a\u627e\u5230\u6307\u5b9a\u5185\u5bb9:<br/>{0}",e),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:n.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}}}]}],buttons:[{id:"saveResult",xtype:"iconlabel",text:""},{xtype:"tbfill"},{xtype:"button",text:"\u4fdd\u5b58",handler:function(d,h){var c=Ext.getCmp("saveForm").getForm(),k=Ext.getCmp("saveResult"),l=Ext.getCmp("organization"),a=[];var b=$$iPems.datetimeParse(Ext.getCmp("startDate").getValue()),i=b.getTime(),j=Ext.Date.subtract(b,Ext.Date.MINUTE,30).getTime(),g=Ext.Date.now();k.setTextWithIcon("","");if(!c.isValid()){k.setTextWithIcon("\u8868\u5355\u586b\u5199\u9519\u8bef","x-icon-error");return false}var f=l.getChecked();if(f.length===0){k.setTextWithIcon("\u8bf7\u52fe\u9009\u9700\u8981\u9884\u7ea6\u7684\u76d1\u63a7\u70b9","x-icon-error");return false}f.forEach(function(e){a.push(e.getId())});if(i<g){Ext.Msg.confirm("\u786e\u8ba4\u5bf9\u8bdd\u6846","\u5f00\u59cb\u65f6\u95f4\u65e9\u4e8e\u5f53\u524d\u65f6\u95f4\uff0c\u60a8\u786e\u5b9a\u8981\u7ee7\u7eed\u5417\uff1f",function(e,m){if(e==="yes"){submit(c,a,k)}})}else{if(j<g){Ext.Msg.confirm("\u786e\u8ba4\u5bf9\u8bdd\u6846","\u5f00\u59cb\u65f6\u95f4\u8ddd\u73b0\u5728\u4e0d\u8db330\u5206\u949f\uff0c\u60a8\u786e\u5b9a\u8981\u7ee7\u7eed\u5417\uff1f",function(e,m){if(e==="yes"){submit(c,a,k)}})}else{submit(c,a,k)}}}},{xtype:"button",text:"\u5173\u95ed",handler:function(a,b){saveWnd.close()}}]});var detailCellClick=function(c,d,b){var a=c.getStore().getAt(d);if(Ext.isEmpty(a)){return false}Ext.Ajax.request({url:"/Project/GetAppointmentDetails",Method:"POST",params:{id:a.data.id},success:function(f,h){var k=Ext.decode(f.responseText,true);if(k.success){var e=detailWnd.getComponent("detail_area");var j=detailWnd.getComponent("detail_station");var i=detailWnd.getComponent("detail_room");var g=detailWnd.getComponent("detail_device");e.setValue(k.data.areas);j.setValue(k.data.stations);i.setValue(k.data.rooms);g.setValue(k.data.devices);detailWnd.show()}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:k.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})};var editCellClick=function(f,g,e){var c=f.getStore().getAt(g);if(Ext.isEmpty(c)){return false}var d=saveWnd.getComponent("saveForm").getForm(),a=Ext.getCmp("organization"),b=a.getRootNode();if(b.hasChildNodes()){b.eachChild(function(h){h.cascadeBy(function(i){i.set("checked",false);i.collapse()})})}d.load({url:"/Project/GetAppointment",params:{id:c.data.id,action:$$iPems.Action.Edit},waitMsg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...",waitTitle:"\u7cfb\u7edf\u63d0\u793a",success:function(i,j){var k="/",h=j.result.data.nodes;if(h&&h.length>0){Ext.Ajax.request({url:"/Component/GetDevicePath",params:{nodes:h},success:function(l,m){var n=Ext.decode(l.responseText,true);if(n.success){Ext.defer(function(){Ext.Array.each(n.data,function(q,o,p){q=Ext.Array.from(q);var r=Ext.String.format("{0}{1}{0}{2}",k,b.getId(),q.join(k));a.selectPath(r,null,null,function(t,s){if(t){s.set("checked",true)}})})},100)}}})}i.clearInvalid();Ext.getCmp("saveResult").setTextWithIcon("","");saveWnd.setGlyph(61442);saveWnd.setTitle("\u7f16\u8f91\u9884\u7ea6");saveWnd.opaction=$$iPems.Action.Edit;saveWnd.show()}})};var deleteCellClick=function(c,d,b){var a=c.getStore().getAt(d);if(Ext.isEmpty(a)){return false}Ext.Msg.confirm("\u786e\u8ba4\u5bf9\u8bdd\u6846","\u60a8\u786e\u8ba4\u8981\u5220\u9664\u5417\uff1f",function(e,f){if(e==="yes"){Ext.Ajax.request({url:"/Project/DeleteAppointment",params:{id:a.raw.id},mask:new Ext.LoadMask(c,{msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(g,h){var i=Ext.decode(g.responseText,true);if(i.success){currentPagingToolbar.doRefresh()}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:i.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}})};var appointmentGridPanel=Ext.create("Ext.grid.Panel",{glyph:61509,title:"\u5de5\u7a0b\u9884\u7ea6\u4fe1\u606f",region:"center",store:currentStore,columnLines:true,disableSelection:false,loadMask:true,forceFit:false,viewConfig:{forceFit:true,trackOver:true,stripeRows:true,emptyText:'<h1 style="margin:20px">\u6ca1\u6709\u6570\u636e\u8bb0\u5f55</h1>',preserveScrollOnRefresh:true},columns:[{text:"\u5e8f\u53f7",dataIndex:"index",width:60,sortable:true},{text:"\u9884\u7ea6\u7f16\u53f7",dataIndex:"id",sortable:false},{text:"\u5f00\u59cb\u65f6\u95f4",dataIndex:"startDate",sortable:true},{text:"\u7ed3\u675f\u65f6\u95f4",dataIndex:"endDate",sortable:true},{text:"\u5de5\u7a0b\u540d\u79f0",dataIndex:"projectName",sortable:true},{text:"\u521b\u5efa\u4eba",dataIndex:"creator",sortable:true},{text:"\u521b\u5efa\u65f6\u95f4",dataIndex:"createdTime",sortable:true},{text:"\u5907\u6ce8\u4fe1\u606f",dataIndex:"comment",sortable:true},{text:"\u9884\u7ea6\u72b6\u6001",dataIndex:"enabled",sortable:true,renderer:function(a){return a?"\u6709\u6548":"\u7981\u7528"}},{xtype:"actioncolumn",width:120,align:"center",menuDisabled:true,menuText:"\u64cd\u4f5c",text:"\u64cd\u4f5c",items:[{iconCls:"x-cell-icon x-icon-detail",handler:function(b,c,a){detailCellClick(b,c,a)}},{getClass:function(b,d,e,f,c,a){return(e.get("creator")===$$iPems.currentEmployee)?"x-cell-icon x-icon-edit":"x-cell-icon x-icon-hidden"},handler:function(b,c,a){editCellClick(b,c,a)}}]}],dockedItems:[{xtype:"panel",dock:"top",items:[Ext.create("Ext.toolbar.Toolbar",{border:false,items:[{id:"type-combobox",xtype:"combobox",fieldLabel:"\u7b5b\u9009\u7c7b\u578b",labelWidth:60,width:250,store:typeStore,align:"center",value:-1,editable:false,displayField:"name",valueField:"id",},{id:"keyword-textbox",xtype:"textfield",labelWidth:50,labelAlign:"center",width:250,maxLength:100,emptyText:"\u591a\u6761\u4ef6\u8bf7\u4ee5;\u5206\u9694\uff0c\u4f8b: A;B;C",},{xtype:"button",text:"\u6570\u636e\u67e5\u8be2",glyph:61445,handler:function(a,b){query(currentStore)}},"-",{xtype:"button",text:"\u6570\u636e\u5bfc\u51fa",glyph:61456,handler:function(a,b){download(currentStore)}}]}),Ext.create("Ext.toolbar.Toolbar",{border:false,items:[{id:"start-datefield",xtype:"datefield",fieldLabel:"\u5f00\u59cb\u65f6\u95f4",labelWidth:60,width:250,value:Ext.Date.add(new Date(),Ext.Date.DAY,-7),editable:false,allowBlank:false},{id:"end-datefield",xtype:"datefield",fieldLabel:"\u7ed3\u675f\u65f6\u95f4",labelWidth:60,width:250,value:Ext.Date.add(new Date(),Ext.Date.DAY,+7),editable:false,allowBlank:false},{xtype:"button",text:"\u65b0\u589e\u9884\u7ea6",glyph:61441,handler:function(d,f){var c=saveWnd.getComponent("saveForm").getForm(),a=Ext.getCmp("organization"),b=a.getRootNode();if(b.hasChildNodes()){b.eachChild(function(e){e.cascadeBy(function(g){g.set("checked",false);g.collapse()})})}c.load({url:"/Project/GetAppointment",params:{action:$$iPems.Action.Add},waitMsg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...",waitTitle:"\u7cfb\u7edf\u63d0\u793a",success:function(e,h){e.clearInvalid();Ext.getCmp("projectId").setReadOnly(false);Ext.getCmp("saveResult").setTextWithIcon("","");var i=Ext.getCmp("projectId"),g=i.getStore();if(g.getCount()>0){i.select(g.getAt(0))}saveWnd.setGlyph(61441);saveWnd.setTitle("\u65b0\u589e\u9884\u7ea6");saveWnd.opaction=$$iPems.Action.Add;saveWnd.show()}})}}]})]}],bbar:currentPagingToolbar});Ext.onReady(function(){var a=Ext.getCmp("center-content-panel-fw");if(!Ext.isEmpty(a)){a.add(appointmentGridPanel);projectStore.load();query(currentStore)}});
