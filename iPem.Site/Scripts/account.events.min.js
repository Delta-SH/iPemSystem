(function(){Ext.define("EventModel",{extend:"Ext.data.Model",fields:[{name:"index",type:"int"},{name:"id",type:"string"},{name:"level",type:"string"},{name:"type",type:"string"},{name:"shortMessage",type:"string"},{name:"ip",type:"string"},{name:"page",type:"string"},{name:"referrer",type:"string"},{name:"user",type:"string"},{name:"created",type:"string"},],idProperty:"id"});var g=function(i){var k=Ext.getCmp("levels-multicombo").getSelectedValues(),j=Ext.getCmp("types-multicombo").getSelectedValues(),h=Ext.getCmp("begin-datefield").getRawValue(),l=Ext.getCmp("end-datefield").getRawValue();i.getProxy().extraParams.levels=k;i.getProxy().extraParams.types=j;i.getProxy().extraParams.startDate=h;i.getProxy().extraParams.endDate=l;i.loadPage(1)};var b=function(h){var i=h.getProxy().extraParams;$$iPems.download({url:"/Account/DownloadEvents",params:i})};var a=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:20,model:"EventModel",proxy:{type:"ajax",url:"/Account/GetEvents",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},listeners:{exception:function(j,i,h){Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:h.getError(),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}},extraParams:{levels:[],types:[],startDate:"",endDate:""},simpleSortMode:true}});var c=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:1024,fields:[{name:"id",type:"string"},{name:"text",type:"string"},{name:"comment",type:"string"}],proxy:{type:"ajax",url:"/Account/GetComboEventLevels",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},listeners:{exception:function(j,i,h){Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:h.getError(),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}}});var e=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:1024,fields:[{name:"id",type:"string"},{name:"text",type:"string"},{name:"comment",type:"string"}],proxy:{type:"ajax",url:"/Account/GetComboEventTypes",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},listeners:{exception:function(j,i,h){Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:h.getError(),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}}});var f=$$iPems.clonePagingToolbar(a);var d=Ext.create("Ext.grid.Panel",{glyph:61481,title:"\u7cfb\u7edf\u65e5\u5fd7\u4fe1\u606f",region:"center",store:a,columnLines:true,disableSelection:false,loadMask:true,forceFit:false,viewConfig:{forceFit:true,trackOver:true,stripeRows:true,emptyText:'<h1 style="margin:20px">\u6ca1\u6709\u6570\u636e\u8bb0\u5f55</h1>',preserveScrollOnRefresh:true},columns:[{text:"\u5e8f\u53f7",dataIndex:"index",width:60,align:"left",sortable:true},{text:"\u7ea7\u522b",dataIndex:"level",width:100,align:"left",sortable:true},{text:"\u7c7b\u578b",dataIndex:"type",width:100,align:"left",sortable:true},{text:"\u65e5\u5fd7\u6458\u8981",dataIndex:"shortMessage",width:100,align:"left",flex:1,sortable:true,renderer:function(m,k,i,n,l,j,h){k.tdAttr=Ext.String.format("data-qtip='{0}'",m);return m}},{text:"\u5ba2\u6237\u7aefIP",dataIndex:"ip",width:100,align:"left",sortable:true},{text:"\u8bf7\u6c42URL",dataIndex:"page",width:100,align:"left",sortable:true},{text:"\u5173\u8054URL",dataIndex:"referrer",width:100,align:"left",sortable:true},{text:"\u7528\u6237\u540d\u79f0",dataIndex:"user",align:"left",width:100,sortable:true},{text:"\u8bb0\u5f55\u65f6\u95f4",dataIndex:"created",align:"left",width:100,sortable:true}],dockedItems:[{xtype:"panel",dock:"top",items:[Ext.create("Ext.toolbar.Toolbar",{border:false,items:[Ext.create("Ext.ux.MultiCombo",{id:"levels-multicombo",fieldLabel:"\u65e5\u5fd7\u7ea7\u522b",valueField:"id",displayField:"text",delimiter:$$iPems.Delimiter,queryMode:"local",triggerAction:"all",selectionMode:"all",emptyText:"\u9ed8\u8ba4\u5168\u90e8",forceSelection:true,labelWidth:60,width:250,store:c}),Ext.create("Ext.ux.MultiCombo",{id:"types-multicombo",fieldLabel:"\u65e5\u5fd7\u7c7b\u578b",valueField:"id",displayField:"text",delimiter:$$iPems.Delimiter,queryMode:"local",triggerAction:"all",selectionMode:"all",emptyText:"\u9ed8\u8ba4\u5168\u90e8",forceSelection:true,labelWidth:60,width:250,store:e}),{id:"query",xtype:"button",glyph:61445,text:"\u6570\u636e\u67e5\u8be2",handler:function(h,i){g(a)}},"-",{xtype:"button",glyph:61456,text:"\u6570\u636e\u5bfc\u51fa",handler:function(h,i){b(a)}}]}),Ext.create("Ext.toolbar.Toolbar",{border:false,items:[{id:"begin-datefield",xtype:"datefield",fieldLabel:"\u5f00\u59cb\u65e5\u671f",labelWidth:60,width:250,value:Ext.Date.add(new Date(),Ext.Date.DAY,-1),editable:false,allowBlank:false},{id:"end-datefield",xtype:"datefield",fieldLabel:"\u7ed3\u675f\u65e5\u671f",labelWidth:60,width:250,value:new Date(),editable:false,allowBlank:false},{xtype:"button",glyph:61475,text:"\u6e05\u7406\u65e5\u5fd7",handler:function(h,i){Ext.Msg.confirm("\u786e\u8ba4\u5bf9\u8bdd\u6846","\u60a8\u786e\u5b9a\u8981\u5220\u9664\u4e09\u4e2a\u6708\u4e4b\u524d\u7684\u65e5\u5fd7\u4fe1\u606f\u5417\uff1f",function(j,k){if(j==="yes"){Ext.Ajax.request({url:"/Account/ClearEvents",mask:new Ext.LoadMask(d,{msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(l,m){var n=Ext.decode(l.responseText,true);if(n.success){Ext.Msg.show({title:"\u7cfb\u7edf\u63d0\u793a",msg:n.message,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:n.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}})}}]})]}],bbar:f});Ext.onReady(function(){var h=Ext.getCmp("center-content-panel-fw");if(!Ext.isEmpty(h)){h.add(d);c.load();e.load();g(a)}})})();
