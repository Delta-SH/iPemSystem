(function(){var e=null,c=null,k={tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},legend:{orient:"vertical",x:"left",y:"center",data:["\u4e00\u7ea7\u544a\u8b66","\u4e8c\u7ea7\u544a\u8b66","\u4e09\u7ea7\u544a\u8b66","\u56db\u7ea7\u544a\u8b66"]},series:[{name:"\u5b9e\u65f6\u544a\u8b66",type:"pie",radius:["45%","85%"],center:["60%","50%"],avoidLabelOverlap:false,label:{normal:{show:false,position:"center"},emphasis:{show:true,textStyle:{fontSize:"13",fontWeight:"bold"}}},labelLine:{normal:{show:false}},data:[{value:0,name:"\u4e00\u7ea7\u544a\u8b66",itemStyle:{normal:{color:"#f04b51"}}},{value:0,name:"\u4e8c\u7ea7\u544a\u8b66",itemStyle:{normal:{color:"#efa91f"}}},{value:0,name:"\u4e09\u7ea7\u544a\u8b66",itemStyle:{normal:{color:"#f5d313"}}},{value:0,name:"\u56db\u7ea7\u544a\u8b66",itemStyle:{normal:{color:"#0892cd"}}}]}]},f={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{top:15,left:0,right:5,bottom:0,containLabel:true},xAxis:[{type:"category",data:[],splitLine:{show:false}}],yAxis:[{type:"value"}],series:[{name:"\u4e00\u7ea7\u544a\u8b66",type:"bar",itemStyle:{normal:{color:"#f04b51"}},data:[]},{name:"\u4e8c\u7ea7\u544a\u8b66",type:"bar",itemStyle:{normal:{color:"#efa91f"}},data:[]},{name:"\u4e09\u7ea7\u544a\u8b66",type:"bar",itemStyle:{normal:{color:"#f5d313"}},data:[]},{name:"\u56db\u7ea7\u544a\u8b66",type:"bar",itemStyle:{normal:{color:"#0892cd"}},data:[]}]};Ext.define("AlarmModel",{extend:"Ext.data.Model",fields:[{name:"index",type:"int"},{name:"fsuid",type:"string"},{name:"id",type:"string"},{name:"level",type:"string"},{name:"levelid",type:"int"},{name:"start",type:"string"},{name:"area",type:"string"},{name:"station",type:"string"},{name:"room",type:"string"},{name:"device",type:"string"},{name:"point",type:"string"},{name:"comment",type:"string"},{name:"value",type:"string"},{name:"frequency",type:"int"},{name:"interval",type:"string"},{name:"confirmed",type:"string"},{name:"confirmer",type:"string"},{name:"confirmedtime",type:"string"},{name:"project",type:"string"}],idProperty:"index"});var h=function(n,l){var m=l.store;m.proxy.extraParams.node=n.getId();m.loadPage(1)};var d=function(l){var m=l.store;m.proxy.extraParams.statype=Ext.getCmp("station-type-multicombo").getSelectedValues();m.proxy.extraParams.roomtype=Ext.getCmp("room-type-multicombo").getSelectedValues();m.proxy.extraParams.devtype=Ext.getCmp("device-type-multicombo").getSelectedValues();m.proxy.extraParams.almlevel=Ext.getCmp("alarm-level-multicombo").getSelectedValues();m.proxy.extraParams.logictype=Ext.getCmp("logic-type-multipicker").getValue();m.proxy.extraParams.pointname=Ext.getCmp("point-name-textfield").getRawValue();m.proxy.extraParams.confirm="all";if(Ext.getCmp("show-confirm-menu").checked){m.proxy.extraParams.confirm="confirm"}if(Ext.getCmp("show-unconfirm-menu").checked){m.proxy.extraParams.confirm="unconfirm"}m.proxy.extraParams.project="all";if(Ext.getCmp("show-project-menu").checked){m.proxy.extraParams.project="project"}if(Ext.getCmp("show-unproject-menu").checked){m.proxy.extraParams.project="unproject"}m.loadPage(1)};var b=function(l){$$iPems.download({url:"/Home/DownloadActAlms",params:l.proxy.extraParams})};var a=function(l){var m=Ext.getCmp("alarms-grid"),n=m.getSelectionModel();if(!n.hasSelection()){Ext.Msg.show({title:"\u7cfb\u7edf\u8b66\u544a",msg:"\u8bf7\u52fe\u9009\u9700\u8981\u786e\u8ba4\u7684\u544a\u8b66",buttons:Ext.Msg.OK,icon:Ext.Msg.WARNING});return false}var o=n.getSelection();Ext.Msg.confirm("\u786e\u8ba4\u5bf9\u8bdd\u6846",Ext.String.format("\u5171{0}\u6761\u544a\u8b66\u5c06\u88ab\u786e\u8ba4\uff0c\u60a8\u786e\u5b9a\u5417\uff1f",o.length),function(p,r){if(p==="yes"){var q=[];Ext.Array.each(o,function(u,s,t){q.push(Ext.String.format("{0}{1}{2}",u.get("fsuid"),$$iPems.Separator,u.get("id")))});Ext.Ajax.request({url:"/Home/ConfirmAlarms",params:{keys:q},mask:new Ext.LoadMask(m,{msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(s,t){var u=Ext.decode(s.responseText,true);if(u.success){l.doRefresh()}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:u.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}})};var g=Ext.create("Ext.window.Window",{title:"\u5de5\u7a0b\u9884\u7ea6",glyph:61509,height:300,width:400,modal:true,border:false,hidden:true,closeAction:"hide",bodyPadding:10,layout:"form",defaultType:"displayfield",items:[{itemId:"id",labelWidth:60,fieldLabel:"\u9884\u7ea6\u7f16\u53f7"},{itemId:"startTime",labelWidth:60,fieldLabel:"\u5f00\u59cb\u65f6\u95f4"},{itemId:"endTime",labelWidth:60,fieldLabel:"\u7ed3\u675f\u65f6\u95f4"},{itemId:"projectName",labelWidth:60,fieldLabel:"\u5de5\u7a0b\u540d\u79f0"},{itemId:"creator",labelWidth:60,fieldLabel:"\u521b\u5efa\u4eba\u5458"},{itemId:"createdTime",labelWidth:60,fieldLabel:"\u521b\u5efa\u65f6\u95f4"},{itemId:"comment",labelWidth:60,fieldLabel:"\u9884\u7ea6\u5907\u6ce8"}],buttonAlign:"right",buttons:[{xtype:"button",text:"\u5173\u95ed",handler:function(l,m){g.hide()}}]});var j=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:20,model:"AlarmModel",proxy:{type:"ajax",actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},url:"/Home/RequestActAlarms",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},extraParams:{node:"root",statype:[],roomtype:[],devtype:[],almlevel:[],logictype:[],pointname:"",confirm:"all",project:"all"},simpleSortMode:true},listeners:{load:function(q,m,o){if(o&&e&&c){var n=q.proxy.reader.jsonData;if(!Ext.isEmpty(n)&&!Ext.isEmpty(n.chart)&&Ext.isArray(n.chart)&&n.chart.length==2){if(!Ext.isEmpty(n.chart[0])){k.series[0].data[0].value=0;k.series[0].data[1].value=0;k.series[0].data[2].value=0;k.series[0].data[3].value=0;Ext.Array.each(n.chart[0],function(x,w){if(x.index==$$iPems.AlmLevel.Level1){k.series[0].data[0].value=x.value}else{if(x.index==$$iPems.AlmLevel.Level2){k.series[0].data[1].value=x.value}else{if(x.index==$$iPems.AlmLevel.Level3){k.series[0].data[2].value=x.value}else{if(x.index==$$iPems.AlmLevel.Level4){k.series[0].data[3].value=x.value}}}}});e.setOption(k)}if(!Ext.isEmpty(n.chart[1])){var v=[],u=[],s=[],r=[],p=[],l={};Ext.Array.each(n.chart[1],function(x,w){if(!l[x.name]){l[x.name]={Key:x.name,L1:0,L2:0,L3:0,L4:0}}if(x.index==$$iPems.AlmLevel.Level1){l[x.name].L1=x.value}else{if(x.index==$$iPems.AlmLevel.Level2){l[x.name].L2=x.value}else{if(x.index==$$iPems.AlmLevel.Level3){l[x.name].L3=x.value}else{if(x.index==$$iPems.AlmLevel.Level4){l[x.name].L4=x.value}}}}});for(var t in l){if(Object.prototype.hasOwnProperty.call(l,t)){v.push(l[t].Key);u.push(l[t].L1);s.push(l[t].L2);r.push(l[t].L3);p.push(l[t].L4)}}f.xAxis[0].data=v;f.series[0].data=u;f.series[1].data=s;f.series[2].data=r;f.series[3].data=p;c.setOption(f)}}$$iPems.Tasks.actAlmTask.fireOnStart=false;$$iPems.Tasks.actAlmTask.restart()}}}});var i=$$iPems.clonePagingToolbar(j);Ext.onReady(function(){var m=Ext.create("Ext.panel.Panel",{id:"currentLayout",region:"center",layout:"border",border:false,items:[{id:"organization",region:"west",xtype:"treepanel",title:"\u7cfb\u7edf\u5c42\u7ea7\u5217\u8868",glyph:61457,width:220,split:true,collapsible:true,collapsed:false,autoScroll:true,useArrows:false,rootVisible:true,root:{id:"root",text:"\u5168\u90e8",expanded:true,icon:$$iPems.icons.Home},viewConfig:{loadMask:true},store:Ext.create("Ext.data.TreeStore",{autoLoad:false,nodeParam:"node",proxy:{type:"ajax",url:"/Component/GetDevices",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"}}}),listeners:{select:function(q,n,p,o){h(n,i)}},tbar:[{id:"organization-search-field",xtype:"textfield",emptyText:"\u8bf7\u8f93\u5165\u7b5b\u9009\u6761\u4ef6...",flex:1,listeners:{change:function(p,q,n,o){delete p._filterData;delete p._filterIndex}}},{id:"alarm-search-button",xtype:"button",glyph:61445,handler:function(){var n=Ext.getCmp("organization"),p=Ext.getCmp("organization-search-field"),r=p.getRawValue();if(Ext.isEmpty(r,false)){return}if(r.length<2){return}if(p._filterData!=null&&p._filterIndex!=null){var o=p._filterIndex+1;var q=p._filterData;if(o>=q.length){o=0;Ext.Msg.show({title:"\u7cfb\u7edf\u63d0\u793a",msg:"\u641c\u7d22\u5b8c\u6bd5",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}$$iPems.selectNodePath(n,q[o]);p._filterIndex=o}else{Ext.Ajax.request({url:"/Component/FilterRoomPath",params:{text:r},mask:new Ext.LoadMask({target:n,msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(t,u){var v=Ext.decode(t.responseText,true);if(v.success){var s=v.data.length;if(s>0){$$iPems.selectNodePath(n,v.data[0]);p._filterData=v.data;p._filterIndex=0}else{Ext.Msg.show({title:"\u7cfb\u7edf\u63d0\u793a",msg:Ext.String.format("\u672a\u627e\u5230\u6307\u5b9a\u5185\u5bb9:<br/>{0}",r),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:v.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}}}]},{region:"center",xtype:"panel",border:false,bodyCls:"x-border-body-panel",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"panel",glyph:61488,title:"\u544a\u8b66\u5206\u7c7b\u5360\u6bd4",collapsible:true,collapseFirst:false,margin:"5 0 0 0",layout:{type:"hbox",align:"stretch",pack:"start"},items:[{xtype:"container",flex:1,contentEl:"pie-chart"},{xtype:"container",flex:2,contentEl:"line-chart"}]},{xtype:"panel",glyph:61481,title:"\u544a\u8b66\u8be6\u7ec6\u4fe1\u606f",collapsible:true,collapseFirst:false,layout:"fit",margin:"5 0 0 0",flex:2,tools:[{type:"refresh",tooltip:"\u5237\u65b0",handler:function(p,o,n){i.doRefresh()}},{type:"print",tooltip:"\u6570\u636e\u5bfc\u51fa",handler:function(p,o,n){b(j)}}],items:[{id:"alarms-grid",xtype:"grid",selType:"checkboxmodel",border:false,store:j,viewConfig:{loadMask:false,stripeRows:true,trackOver:true,preserveScrollOnRefresh:true,emptyText:'<h1 style="margin:20px">\u6ca1\u6709\u6570\u636e\u8bb0\u5f55</h1>',getRowClass:function(n,q,p,o){return $$iPems.GetAlmLevelCls(n.get("levelid"))}},listeners:{cellclick:function(u,o,s,p,r,t,q){var v=u.ownerCt.columns[s].dataIndex;if(v!=="project"){return}var n=p.get(v);if(Ext.isEmpty(n)){return}Ext.Ajax.request({url:"/Home/GetAppointmentDetail",Method:"POST",params:{id:n},mask:new Ext.LoadMask(u.ownerCt,{msg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e..."}),success:function(z,E){var A=Ext.decode(z.responseText,true);if(A.success){var w=g.getComponent("id");var x=g.getComponent("startTime");var C=g.getComponent("endTime");var F=g.getComponent("projectName");var y=g.getComponent("creator");var D=g.getComponent("createdTime");var B=g.getComponent("comment");w.setValue(A.data.id);x.setValue(A.data.startTime);C.setValue(A.data.endTime);F.setValue(A.data.projectName);y.setValue(A.data.creator);D.setValue(A.data.createdTime);B.setValue(A.data.comment);g.show()}else{Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:A.message,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}})}},columns:[{text:"\u5e8f\u53f7",dataIndex:"index",width:60},{text:"\u544a\u8b66\u7ea7\u522b",dataIndex:"level",align:"center",tdCls:"x-level-cell"},{text:"\u544a\u8b66\u65f6\u95f4",dataIndex:"start",width:150},{text:"\u6240\u5c5e\u533a\u57df",dataIndex:"area"},{text:"\u6240\u5c5e\u7ad9\u70b9",dataIndex:"station"},{text:"\u6240\u5c5e\u673a\u623f",dataIndex:"room"},{text:"\u6240\u5c5e\u8bbe\u5907",dataIndex:"device"},{text:"\u4fe1\u53f7\u540d\u79f0",dataIndex:"point"},{text:"\u544a\u8b66\u63cf\u8ff0",dataIndex:"comment"},{text:"\u89e6\u53d1\u503c",dataIndex:"value"},{text:"\u89e6\u53d1\u9891\u6b21",dataIndex:"frequency"},{text:"\u544a\u8b66\u5386\u65f6",dataIndex:"interval"},{text:"\u786e\u8ba4\u72b6\u6001",dataIndex:"confirmed"},{text:"\u786e\u8ba4\u4eba\u5458",dataIndex:"confirmer"},{text:"\u786e\u8ba4\u65f6\u95f4",dataIndex:"confirmedtime"},{text:"\u5de5\u7a0b\u9884\u7ea6",dataIndex:"project",renderer:function(o,q,n){return Ext.String.format('<a href="javascript:void(0)" style="color:#157fcc;">{0}</a>',o)}}],bbar:i,}]}],dockedItems:[{xtype:"panel",glyph:61492,title:"\u544a\u8b66\u7b5b\u9009\u6761\u4ef6",collapsible:true,collapsed:false,dock:"top",items:[{xtype:"toolbar",border:false,items:[{id:"station-type-multicombo",xtype:"StationTypeMultiCombo",emptyText:"\u9ed8\u8ba4\u5168\u90e8"},{id:"room-type-multicombo",xtype:"RoomTypeMultiCombo",emptyText:"\u9ed8\u8ba4\u5168\u90e8"},{id:"device-type-multicombo",xtype:"DeviceTypeMultiCombo",emptyText:"\u9ed8\u8ba4\u5168\u90e8"},{xtype:"splitbutton",glyph:61445,text:"\u786e\u5b9a",handler:function(o,n){d(i)},menu:[{text:"\u544a\u8b66\u786e\u8ba4",glyph:61493,hidden:!$$iPems.ConfirmOperation,handler:function(o,n){a(i)}},{xtype:"menuseparator",hidden:!$$iPems.ConfirmOperation},{text:"\u6570\u636e\u5bfc\u51fa",glyph:61456,handler:function(o,n){b(j)}}]}]},{xtype:"toolbar",border:false,items:[{id:"logic-type-multipicker",xtype:"LogicTypeMultiPicker",emptyText:"\u9ed8\u8ba4\u5168\u90e8",width:220},{id:"point-name-textfield",xtype:"textfield",fieldLabel:"\u4fe1\u53f7\u540d\u79f0",emptyText:"\u591a\u6761\u4ef6\u8bf7\u4ee5;\u5206\u9694\uff0c\u4f8b: A;B;C",labelWidth:60,width:220},{id:"alarm-level-multicombo",xtype:"AlarmLevelMultiCombo",emptyText:"\u9ed8\u8ba4\u5168\u90e8"},{id:"other-option-button",xtype:"button",text:"\u5176\u4ed6\u9009\u9879",menu:[{id:"show-confirm-menu",xtype:"menucheckitem",text:"\u5df2\u786e\u8ba4\u544a\u8b66",checked:false,checkHandler:function(o,n){if(n){Ext.getCmp("show-unconfirm-menu").setChecked(false)}}},{id:"show-unconfirm-menu",xtype:"menucheckitem",text:"\u672a\u786e\u8ba4\u544a\u8b66",checked:false,checkHandler:function(o,n){if(n){Ext.getCmp("show-confirm-menu").setChecked(false)}}},"-",{id:"show-project-menu",xtype:"menucheckitem",text:"\u5de5\u7a0b\u544a\u8b66",checked:false,checkHandler:function(o,n){if(n){Ext.getCmp("show-unproject-menu").setChecked(false)}}},{id:"show-unproject-menu",xtype:"menucheckitem",text:"\u975e\u5de5\u7a0b\u544a\u8b66",checked:false,checkHandler:function(o,n){if(n){Ext.getCmp("show-project-menu").setChecked(false)}}},]}]}]}]}]});$$iPems.Tasks.actAlmTask.run=function(){i.doRefresh()};$$iPems.Tasks.actAlmTask.start();var l=Ext.getCmp("center-content-panel-fw");if(!Ext.isEmpty(l)){l.add(m)}});Ext.onReady(function(){e=echarts.init(document.getElementById("pie-chart"),"shine");c=echarts.init(document.getElementById("line-chart"),"shine");e.setOption(k);c.setOption(f)})})();
