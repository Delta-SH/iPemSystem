Ext.define("ProjectModel",{extend:"Ext.data.Model",fields:[{name:"index",type:"int"},{name:"id",type:"string"},{name:"name",type:"string"},{name:"start",type:"string"},{name:"end",type:"string"},{name:"responsible",type:"string"},{name:"contact",type:"string"},{name:"company",type:"string"},{name:"creator",type:"string"},{name:"createdtime",type:"string"},{name:"comment",type:"string"},{name:"enabled",type:"boolean"}],idProperty:"id"});var query=function(b){var d=Ext.getCmp("names-textfield"),a=Ext.getCmp("start-datefield"),c=Ext.getCmp("end-datefield");b.getProxy().extraParams.name=d.getRawValue();b.getProxy().extraParams.startDate=a.getRawValue();b.getProxy().extraParams.endDate=c.getRawValue();b.loadPage(1)};var download=function(a){var b=a.getProxy().extraParams;$$iPems.download({url:"/Project/DownloadProjects",params:b})};var currentStore=Ext.create("Ext.data.Store",{autoLoad:false,pageSize:20,model:"ProjectModel",proxy:{type:"ajax",url:"/Project/GetProjects",reader:{type:"json",successProperty:"success",messageProperty:"message",totalProperty:"total",root:"data"},listeners:{exception:function(c,b,a){Ext.Msg.show({title:"\u7cfb\u7edf\u9519\u8bef",msg:a.getError(),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}},simpleSortMode:true}});var currentPagingToolbar=$$iPems.clonePagingToolbar(currentStore);var saveWnd=Ext.create("Ext.window.Window",{title:"Project",height:400,width:600,modal:true,border:false,hidden:true,closeAction:"hide",opaction:$$iPems.Action.Add,items:[{xtype:"form",id:"saveForm",border:false,defaultType:"textfield",fieldDefaults:{labelWidth:60,labelAlign:"left",margin:"15 15 15 15",anchor:"100%"},items:[{xtype:"container",layout:"hbox",items:[{xtype:"container",flex:1,layout:"anchor",items:[{name:"id",xtype:"textfield",fieldLabel:"\u5de5\u7a0b\u6807\u8bc6",allowBlank:false,readOnly:true},{name:"start",xtype:"datefield",fieldLabel:"\u5f00\u59cb\u65f6\u95f4",allowBlank:false,editable:false},{name:"responsible",xtype:"textfield",fieldLabel:"\u8d1f\u8d23\u4eba\u5458",allowBlank:false},{name:"comment",xtype:"textareafield",fieldLabel:"\u5907\u6ce8\u4fe1\u606f",height:100},]},{xtype:"container",flex:1,layout:"anchor",items:[{id:"name",name:"name",xtype:"textfield",fieldLabel:"\u5de5\u7a0b\u540d\u79f0",allowBlank:false},{name:"end",xtype:"datefield",fieldLabel:"\u7ed3\u675f\u65f6\u95f4",allowBlank:false,editable:false},{name:"contact",xtype:"textfield",fieldLabel:"\u8054\u7cfb\u7535\u8bdd",allowBlank:false},{name:"company",xtype:"textfield",fieldLabel:"\u65bd\u5de5\u516c\u53f8",allowBlank:false},{name:"enabled",xtype:"checkboxfield",fieldLabel:"\u5de5\u7a0b\u72b6\u6001",boxLabel:"(\u52fe\u9009\u8868\u793a\u542f\u7528)",inputValue:true,checked:true}]}]}]}],buttons:[{id:"saveResult",xtype:"iconlabel",text:""},{xtype:"tbfill"},{xtype:"button",text:"\u4fdd\u5b58",handler:function(b,d){var c=Ext.getCmp("saveForm").getForm(),a=Ext.getCmp("saveResult");a.setTextWithIcon("","");if(c.isValid()){a.setTextWithIcon("\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...","x-icon-loading");c.submit({submitEmptyText:false,clientValidation:true,preventWindow:true,url:"/Project/SaveProject",params:{action:saveWnd.opaction},success:function(e,f){a.setTextWithIcon(f.result.message,"x-icon-accept");if(saveWnd.opaction==$$iPems.Action.Add){currentStore.loadPage(1)}else{currentPagingToolbar.doRefresh()}},failure:function(f,g){var e="undefined error.";if(!Ext.isEmpty(g.result)&&!Ext.isEmpty(g.result.message)){e=g.result.message}a.setTextWithIcon(e,"x-icon-error")}})}else{a.setTextWithIcon("\u8868\u5355\u586b\u5199\u9519\u8bef","x-icon-error")}}},{xtype:"button",text:"\u5173\u95ed",handler:function(a,b){saveWnd.close()}}]});var editCellClick=function(c,d,b){var a=c.getStore().getAt(d);if(Ext.isEmpty(a)){return false}Ext.getCmp("saveForm").getForm().load({url:"/Project/GetProject",params:{id:a.raw.id,action:$$iPems.Action.Edit},waitMsg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...",waitTitle:"\u7cfb\u7edf\u63d0\u793a",success:function(e,f){e.clearInvalid();Ext.getCmp("name").setReadOnly(true);Ext.getCmp("saveResult").setTextWithIcon("","");saveWnd.setGlyph(61442);saveWnd.setTitle("\u7f16\u8f91\u5de5\u7a0b");saveWnd.opaction=$$iPems.Action.Edit;saveWnd.show()}})};var currentPanel=Ext.create("Ext.grid.Panel",{glyph:61510,title:"\u5de5\u7a0b\u7ba1\u7406\u4fe1\u606f",region:"center",store:currentStore,columnLines:true,disableSelection:false,loadMask:true,forceFit:false,listeners:{},viewConfig:{forceFit:false,trackOver:true,stripeRows:true,emptyText:'<h1 style="margin:20px">\u6ca1\u6709\u6570\u636e\u8bb0\u5f55</h1>',preserveScrollOnRefresh:true},columns:[{text:"\u5e8f\u53f7",dataIndex:"index",width:60,align:"left",sortable:true},{text:"\u5de5\u7a0b\u6807\u8bc6",dataIndex:"id",align:"left",sortable:false},{text:"\u5de5\u7a0b\u540d\u79f0",dataIndex:"name",align:"left",sortable:false},{text:"\u5f00\u59cb\u65f6\u95f4",dataIndex:"start",align:"center",sortable:true},{text:"\u7ed3\u675f\u65f6\u95f4",dataIndex:"end",align:"center",sortable:true},{text:"\u8d1f\u8d23\u4eba\u5458",dataIndex:"responsible",align:"left",sortable:true},{text:"\u8054\u7cfb\u7535\u8bdd",dataIndex:"contact",align:"left",sortable:true},{text:"\u65bd\u5de5\u516c\u53f8",dataIndex:"company",align:"left",sortable:true},{text:"\u521b\u5efa\u4eba\u5458",dataIndex:"creator",align:"left",sortable:true},{text:"\u521b\u5efa\u65f6\u95f4",dataIndex:"createdtime",align:"left",sortable:true},{text:"\u5907\u6ce8\u4fe1\u606f",dataIndex:"comment",align:"left",sortable:true},{text:"\u5de5\u7a0b\u72b6\u6001",dataIndex:"enabled",align:"left",sortable:true,renderer:function(a){return a?"\u6709\u6548":"\u7981\u7528"}},{xtype:"actioncolumn",width:100,align:"center",menuDisabled:true,menuText:"\u64cd\u4f5c",text:"\u64cd\u4f5c",items:[{getClass:function(b,d,e,f,c,a){return(e.get("creator")===$$iPems.currentEmployee)?"x-cell-icon x-icon-edit":"x-cell-icon x-icon-hidden"},handler:function(c,d,b){var a=c.getStore().getAt(d);if(Ext.isEmpty(a)){return false}editCellClick(c,d,b)}}]}],dockedItems:[{xtype:"panel",dock:"top",items:[Ext.create("Ext.toolbar.Toolbar",{border:false,items:[Ext.create("Ext.form.TextField",{id:"names-textfield",fieldLabel:"\u5de5\u7a0b\u540d\u79f0",labelWidth:60,width:508,maxLength:100,emptyText:"\u591a\u6761\u4ef6\u8bf7\u4ee5;\u5206\u9694\uff0c\u4f8b: A;B;C"}),{xtype:"button",text:"\u6570\u636e\u67e5\u8be2",glyph:61445,handler:function(a,b){query(currentStore)}},"-",{xtype:"button",text:"\u6570\u636e\u5bfc\u51fa",glyph:61456,handler:function(a,b){download(currentStore)}}]}),Ext.create("Ext.toolbar.Toolbar",{border:false,items:[{id:"start-datefield",xtype:"datefield",fieldLabel:"\u5f00\u59cb\u65f6\u95f4",labelWidth:60,width:250,value:Ext.Date.getFirstDateOfMonth(new Date()),editable:false,allowBlank:false},{id:"end-datefield",xtype:"datefield",fieldLabel:"\u7ed3\u675f\u65f6\u95f4",labelWidth:60,value:Ext.Date.subtract(Ext.Date.add(Ext.Date.getFirstDateOfMonth(new Date()),Ext.Date.MONTH,+1),Ext.Date.SECOND,1),width:250,editable:false,allowBlank:false},{xtype:"button",text:"\u65b0\u589e\u5de5\u7a0b",glyph:61441,handler:function(a,c){var b=Ext.getCmp("saveForm").getForm();b.load({url:"/Project/GetProject",params:{id:"",action:$$iPems.Action.Add},waitMsg:"\u6b63\u5728\u5904\u7406\uff0c\u8bf7\u7a0d\u540e...",waitTitle:"\u7cfb\u7edf\u63d0\u793a",success:function(d,e){d.clearInvalid();Ext.getCmp("saveResult").setTextWithIcon("","");saveWnd.setGlyph(61441);saveWnd.setTitle("\u65b0\u589e\u5de5\u7a0b");saveWnd.opaction=$$iPems.Action.Add;saveWnd.show()}})}}]})]}],bbar:currentPagingToolbar});Ext.onReady(function(){var a=Ext.getCmp("center-content-panel-fw");if(!Ext.isEmpty(a)){a.add(currentPanel);query(currentStore)}});
